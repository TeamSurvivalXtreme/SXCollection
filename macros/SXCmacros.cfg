# This is the only define that must not use indentation because it's used directly in texts and all spaces are included in the messages
#define SXC_VERSION
0.2.124#enddef

#
# !!! From this position, I strongly recommend to use 2 spaces per indentation level, due to better transparency of the code !!!
# !!! Also set your editing software to not insert <TAB> characters automatically instead of set number of spaces !!!
#

# Macro for descriptions that need an empty line, so that the description itself is easier to read
#define SXC_MAP_NOTES_NEW_PARAGRAPH
  "

"#enddef

#define SXC_MAP_DEFAULT_DESCRIPTION
  _ "In SurvivalXtreme, you have to kill all enemy leaders or survive until the turn limit expires. You play only with your leader but you can enhance it during the game. You get gold, extra moves and an extra attack for every enemy you kill. Use default map settings otherwise you will lose immediately. Have fun!"#enddef

#define SXC_MAP_NOTES_REQUIRES_AGELESS
  _ "This map requires Ageless Era to be installed on every player's computer" + {SXC_MAP_NOTES_NEW_PARAGRAPH}#enddef

# This is macro for easier settings for normal SX maps
#define SXC_DEFAULT_MAP_SETTINGS TURNS CONDITION STORY_BACKGROUND STORY
  experience_modifier=130%
  turns=-1
  victory_when_enemies_defeated=no
  {DEFAULT_SCHEDULE}
  {SXC_MUSIC_PLAYLIST}
  {SXC_FORCE_MAP_SETTINGS}

  [story]
    [part]
      background={STORY_BACKGROUND}
      show_title=yes
      story={STORY}
    [/part]
    [part]
      background="{STORY_BACKGROUND}"
      show_title=yes
      story="<span color='#FF2020' size='large' weight='bold'>SXCollection {SXC_VERSION}</span>"
    [/part]
  [/story]

  [event]
    name="start"
    {VARIABLE turns 1}
    {VARIABLE_OP turns add {TURNS}}
    {VARIABLE condition {CONDITION}}
    [objectives]
      summary="SXCollection {SXC_VERSION}"
      [objective]
        [show_if]
          {SXC_CMP condition equals "win"}
        [/show_if]
        description="<span weight='bold'>Survive until turn $turns| or defeat all enemy leaders.</span>"
        condition=win
      [/objective]
      [objective]
        [show_if]
          {SXC_CMP condition equals "lose"}
        [/show_if]
        description="<span weight='bold'>Defeat all enemy leaders.</span>"
        condition=win
      [/objective]
      [objective]
        [show_if]
          {SXC_CMP cashstop_4 less_than 1000}
        [/show_if]
        description="<span color='yellow' weight='bold'>Kill AI leader of side 4 within $cashstop_4| turns, later you will not gain gold for killing units of AI side 4.</span>"
        condition=win
      [/objective]
      [objective]
        [show_if]
          {SXC_CMP cashstop_5 less_than 1000}
        [/show_if]
        description="<span color='yellow' weight='bold'>Kill AI leader of side 5 within $cashstop_5| turns, later you will not gain gold for killing units of AI side 5.</span>"
        condition=win
      [/objective]
      [objective]
        [show_if]
          {SXC_CMP cashstop_6 less_than 1000}
        [/show_if]
        description="<span color='yellow' weight='bold'>Kill AI leader of side 6 within $cashstop_6| turns, later you will not gain gold for killing units of AI side 6.</span>"
        condition=win
      [/objective]
      [objective]
        [show_if]
          {SXC_CMP cashstop_7 less_than 1000}
        [/show_if]
        description="<span color='yellow' weight='bold'>Kill AI leader of side 7 within $cashstop_7| turns, later you will not gain gold for killing units of AI side 7.</span>"
        condition=win
      [/objective]
      [objective]
        [show_if]
          {SXC_CMP cashstop_8 less_than 1000}
        [/show_if]
        description="<span color='yellow' weight='bold'>Kill AI leader of side 8 within $cashstop_8| turns, later you will not gain gold for killing units of AI side 8.</span>"
        condition=win
      [/objective]
      [objective]
        [show_if]
          {SXC_CMP cashstop_9 less_than 1000}
        [/show_if]
        description="<span color='yellow' weight='bold'>Kill AI leader of side 9 within $cashstop_9| turns, later you will not gain gold for killing units of AI side 9.</span>"
        condition=win
      [/objective]
      [objective]
        [show_if]
          {SXC_CMP condition equals "win"}
        [/show_if]
        description="<span weight='bold'>Death of your hero</span>"
        condition=lose
      [/objective]
      [objective]
        [show_if]
          {SXC_CMP condition equals "lose"}
        [/show_if]
        description="<span weight='bold'>Death of your hero or you will not defeat all enemy leaders until turn $turns|.</span>"
        condition=lose
      [/objective]
    [/objectives]
    {VARIABLE timeend.name "turn $turns|"}
    {VARIABLE timeend.if.variable.name "condition"}
    {VARIABLE timeend.if.variable.equals "win"}
    {VARIABLE timeend.if.then.message.speaker "narrator"}
    {VARIABLE timeend.if.then.message.message "You survived until turn $turns|! Congratulations! That means you've won!"}
    {VARIABLE timeend.if.then.message.image "wesnoth-icon.png"}
    {VARIABLE timeend.if.then.endlevel.result "victory"}
    {VARIABLE timeend.if.else.message.speaker "narrator"}
    {VARIABLE timeend.if.else.message.message "You didn't managed to kill all enemy leaders in the time you had! That means you've lost!"}
    {VARIABLE timeend.if.else.message.image "wesnoth-icon.png"}
    {VARIABLE timeend.if.else.endlevel.result "defeat"}
    [insert_tag]
      name=event
      variable=timeend
    [/insert_tag]
  [/event]

  [event]
    name=new turn
    first_time_only=no
    [if]
      [not]
        [have_unit]
          role=big_boss
        [/have_unit]
      [/not]
      [not]
        [have_unit]
          role=fake_boss
        [/have_unit]
      [/not]
      [then]
        [message]
          speaker=narrator
          message="You defeated all enemy leaders! Congratulations! That means you've won!"
          image=wesnoth-icon.png
        [/message]
        [endlevel]
          result=victory
        [/endlevel]
      [/then]
      [else]
        [store_unit]
          [filter]
            role="big_boss"
          [/filter]
          variable=leaders
        [/store_unit]
        {VARIABLE side_x 0}
        [while]
          {SXC_CMP side_x less_than $leaders.length}
          [do]
            {VARIABLE leaders[$side_x|].canrecruit "yes"}
            [unstore_unit]
              variable=leaders[$side_x|]
            [/unstore_unit]
            {VARIABLE_OP side_x add 1}
          [/do]
        [/while]
        {CLEAR_VARIABLE leaders}
        {CLEAR_VARIABLE side_x}
      [/else]
    [/if]
  [/event]

  {SXC_KILL}
  {SXC_ENEMY_DEATH_EVENT}
  {SXC_DEATH_MESSAGES}
  {SXC_ENEMY_UPGRADE}
  {SXC_MEGA_CHALLENGE}
#enddef

# Default settings checking routine
#
#define SXC_FORCE_MAP_SETTINGS
  [event]
    name="start"
    [store_side]
      side=6
      variable=defaultcheck
    [/store_side]
    [if]
      [variable]
        name=defaultcheck.team_name
        not_equals=Enemies
      [/variable]
      [then]
        [message]
          speaker=narrator
          message="Please use default Map Settings. This scenario will not work if default settings are not used. Using non-default settings will result in defeat."
          image=wesnoth-icon.png
        [/message]
        [endlevel]
          result=defeat
        [/endlevel]
      [/then]
    [/if]
  [/event]
#enddef

# Defines blank function
#define BLANK
#enddef

# Shortcut for conditional testing of 2 variables
#define SXC_CMP VARIABLE1 OPERAND VARIABLE2
  [variable]
    name={VARIABLE1}
    {OPERAND}={VARIABLE2}
  [/variable]
#enddef

# Math rounding routine
#define SXC_ROUND VARIABLE1 OPERAND VARIABLE2 ROUND_TYPE
  [set_variable]
    name={VARIABLE1}
    {OPERAND}={VARIABLE2}
    round={ROUND_TYPE}
  [/set_variable]
#enddef

# Initial variables for all used macros (change individually on per map base after using this macro)
#define SXC_INIT_VARIABLES
  {VARIABLE item[0].x 999}
  {VARIABLE item[0].y 999}
  {VARIABLE item[0].type "NOTHING"}
  {VARIABLE item[0].image ""}
  {VARIABLE item[0].halo ""}
  {VARIABLE item[0].used 0}
  {VARIABLE arcane 0.225397}
  {VARIABLE blade 0.115325}
  {VARIABLE cold 0.144156}
  {VARIABLE fire 0.179798}
  {VARIABLE impact 0.125245}
  {VARIABLE pierce 0.123077}
  {VARIABLE melee 5}
  {VARIABLE ranged 4}
  {VARIABLE weapons_index 100}
  {VARIABLE units_index 1000}
  {VARIABLE cashstop_4 1000}
  {VARIABLE cashstop_5 1000}
  {VARIABLE cashstop_6 1000}
  {VARIABLE cashstop_7 1000}
  {VARIABLE cashstop_8 1000}
  {VARIABLE cashstop_9 1000}
  {VARIABLE cashstop_10 1000}
  {VARIABLE cashstop_11 1000}
  {VARIABLE allow_shop_potions "no"}
  {VARIABLE allow_shop_blackp "no"}
  {VARIABLE allow_shop_bluep "no"}
  {VARIABLE allow_shop_brownp "no"}
  {VARIABLE allow_shop_cyanp "no"}
  {VARIABLE allow_shop_greyp "no"}
  {VARIABLE allow_shop_greenp "no"}
  {VARIABLE allow_shop_orangep "no"}
  {VARIABLE allow_shop_pinkp "no"}
  {VARIABLE allow_shop_redp "no"}
  {VARIABLE allow_shop_violetp "no"}
  {VARIABLE allow_shop_whitep "no"}
  {VARIABLE allow_shop_yellowp "no"}
  {VARIABLE melee_specials "backstab,berserk,charge,evade,magical,rage,slow"}
  {VARIABLE ranged_specials "backstab,evade,focus,magical,marksman,precision,slow"}
# EVERY of next lines must contain , at start and end of line to get working comparation for full name of special otherwise partial specials names will match too, i.e. rage10 will match to rage, even if it's different special.
  {VARIABLE backstab_combinations ",attack_only,blind,charm,circle,concentrated,counter,drains,dread,evade,evasion,ferocious,firststrike,guided,highground,magical,marksman,massivestrike,nocounter,poison,precision,recieve,return,slow,spread,sxc_evade,sxc_precision,"}
  {VARIABLE berserk_combinations ",attack_only,blind,charm,firststrike,massivestrike,poison,recieve,spread,sxc_evade,"}
  {VARIABLE charge_combinations ",attack_only,blind,charm,circle,concentrated,counter,dread,evade,evasion,ferocious,firststrike,guided,magical,marksman,massivestrike,poison,precision,recieve,return,slow,spread,sxc_evade,sxc_precision,"}
  {VARIABLE evade_combinations ",arson,attack_only,backstab,blind,charge,circle,cleave,concentrated,counter,defend_only,drains,ferocious,firststrike,focus,guided,highground,magical,marksman,massivestrike,poison,precision,rage,rage2,rage3,recieve,return,slow,spread,sxc_berserk,sxc_focus,sxc_precision,sxc_rage,triplestrike,udbane,"}
  {VARIABLE focus_combinations ",attack_only,charm,dread,evade,evasion,firststrike,nocounter,poison,rage,rage2,rage3,recieve,slow,spread,sxc_evade,sxc_rage,triplestrike,"}
  {VARIABLE magical_combinations ",attack_only,backstab,charge,charm,cleave,dread,evade,evasion,firststrike,highground,nocounter,poison,rage,rage2,rage3,recieve,slow,spread,sxc_evade,sxc_rage,triplestrike,"}
  {VARIABLE marksman_combinations ",attack_only,backstab,charm,cleave,drains,dread,evade,evasion,firststrike,highground,nocounter,poison,rage,rage2,rage3,recieve,slow,spread,sxc_evade,sxc_rage,triplestrike,"}
  {VARIABLE precision_combinations ",attack_only,backstab,charm,cleave,dread,evade,evasion,firststrike,highground,nocounter,poison,rage,rage2,rage3,recieve,slow,spread,sxc_evade,sxc_rage,triplestrike,"}
  {VARIABLE rage_combinations ",attack_only,blind,charm,cleave,dread,evade,evasion,ferocious,firststrike,focus,guided,magical,marksman,massivestrike,poison,precision,recieve,slow,spread,sxc_evade,sxc_focus,sxc_precision,"}
  {VARIABLE slow_combinations ",arson,attack_only,backstab,blind,charge,charm,circle,cleave,concentrated,counter,defend_only,drains,dread,evade,evasion,ferocious,firststrike,focus,guided,highground,magical,marksman,massivestrike,nocounter,poison,precision,rage,rage2,rage3,recieve,return,spread,sxc_evade,sxc_focus,sxc_precision,sxc_rage,triplestrike,udbane,"}
  # These are used in non-revive mode
  [set_variables]
    name=death_texts_dead
    mode=replace
    [value]
      value=_ "dead^Argh... I guess that was my last adventure..."
    [/value]
    [value]
      value=_ "dead^This cannot be..."
    [/value]
    [value]
      value=_ "dead^I'm... dying..."
    [/value]
    [value]
      value=_ "dead^Urgh. I should never have come here..."
    [/value]
    [value]
      value=_ "dead^Argh. I'm done for."
    [/value]
    [value]
      value=_ "dead^Sorry... friends... i can't..."
    [/value]
    [value]
      value=_ "dead^Why... me..."
    [/value]
    [value]
      value=_ "dead^This really... hurts..."
    [/value]
    [value]
      value=_ "dead^Where is my gold..."
    [/value]
    [value]
      value=_ "dead^I can't die... now..."
    [/value]
  [/set_variables]
  # These are used revive mode, with a note that the character will revive added
  [set_variables]
    name=death_texts_revive
    mode=replace
    [value]
      value=_ "revive^This could be my last adventure..."
    [/value]
    [value]
      value=_ "revive^This cannot be..."
    [/value]
    [value]
      value=_ "revive^Back to the shop..."
    [/value]
    [value]
      value=_ "revive^I must reach the shop..."
    [/value]
    [value]
      value=_ "revive^Urgh. I should never have come here..."
    [/value]
    [value]
      value=_ "revive^Argh. I need to retreat..."
    [/value]
    [value]
      value=_ "revive^Sorry... friends... i can't..."
    [/value]
    [value]
      value=_ "revive^Why... me..."
    [/value]
    [value]
      value=_ "revive^Where is my gold..."
    [/value]
  [/set_variables]
  {VARIABLE recruits_6 0}
  {VARIABLE recruits_7 0}
  {VARIABLE recruits_8 0}
  {VARIABLE recruits_9 0}
  {VARIABLE recruits_10 0}
  {VARIABLE recruits_11 0}

  {SXC_ARMORY_LIMIT_EVENT}
  [event]
    name=advance
    first_time_only=no
    [filter]
      [filter_side]
        team_name=Heroes
      [/filter_side]
      canrecruit=yes
      x,y=$x1,$y1
    [/filter]
    [store_unit]
      [filter]
        x,y=$x1,$y1
      [/filter]
      variable=preadvance
    [/store_unit]
    {VARIABLE pre_advance $preadvance.hitpoints}
    {VARIABLE pre_id $preadvance.type}
    {CLEAR_VARIABLE preadvance}
  [/event]

  [event]
    name=post_advance
    first_time_only=no
    [filter]
      x,y=$x1,$y1
      [filter_side]
        team_name=Heroes
      [/filter_side]
      canrecruit=yes
    [/filter]
    [store_unit]
      [filter]
        x,y=$x1,$y1
      [/filter]
      variable=postadvance
    [/store_unit]
    [object]
      silent=yes
      duration=forever
      [effect]
        apply_to=hitpoints
        heal_full=yes
        violate_maximum=yes
      [/effect]
      {SXC_TRAIT_EFFECTS}
    [/object]
    [if]
      {SXC_CMP pre_advance greater_than $postadvance.hitpoints}
      [then]
        {VARIABLE_OP pre_advance sub $postadvance.hitpoints}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=hitpoints
            increase=$pre_advance
            violate_maximum=yes
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP pre_id not_equals $postadvance.type}
      [then]
        {SXC_CHECK_ARMOR_TOTAL $postadvance.side}
        {SXC_UNIT_MOVEMENTS_RESTORE $postadvance.side}
      [/then]
    [/if]
#     {SXC_DISALLOW_RECRUITS $postadvance.side}
    {CLEAR_VARIABLE pre_advance}
    {CLEAR_VARIABLE pre_id}
    {CLEAR_VARIABLE postadvance}
  [/event]
#enddef

#define SXC_DISALLOW_RECRUITS SIDE
    [store_side]
      side={SIDE}
      variable=disrec
    [/store_side]
    [disallow_recruit]
      side={SIDE}
      type="$disrec.recruit"
    [/disallow_recruit]
    {CLEAR_VARIABLE disrec}
#enddef

#                 bkstb bersk chrge evade focus magic marks precs rage3 slow
# absorb            0     0     0     0     0     0     0     0     0     0   This unit absorbs the body of living units. It is able to surpass its maximum health through draining when attacking
# arson             0     0     0     1     0     0     0     0     0     1   This unit uses the terrain against the enemy by lighting it on fire, its damage increases by 25% when the enemy is on forest, castle, or a village tile, or other manmade structure (farms and windmills) but decreases by 25% if he or the enemy is in water (if both are, the unit does 40% less damage). ::Note:: Villages or castles with water or swamp are considered water."
# attack_only       1     1     1     1     1     1     1     1     1     1   Weapon is only used on offense
# backstab          X     0     0     1     0     1     1     1     0     1   Doubles damage when used from back side of enemy unit
# berserk           0     X     0     0     0     0     0     0     0     0   30 rounds of attacks or death of one combater
# blind             1     1     1     1     0     0     0     0     1     1   This unit cannot see, and has a 20% chance to hit on offense.
# charge            0     0     X     1     0     1     1     1     0     1   Doubles damage for both attacker and defender
# charm             1     1     1     0     1     1     1     1     1     1   When this attack is used defencively, this unit takes one third less damage in retaliation.
# circle            1     0     1     1     0     0     0     0     0     1   This attack always has a 100% chance to hit
# cleave            0     0     0     1     0     1     1     1     1     1   This unit swings wide, and does 2 damage to any units adjacent to both attacker and defender.
# concentrated      1     0     1     1     0     0     0     0     0     1   Concentrated: When this attack is used, this units damage increases after each successful hit.
# counter           1     0     1     1     0     0     0     0     0     1   When used defensively, this attack always has at least a 60% chance to hit.
# defend_only       0     0     0     1     0     0     0     0     0     1   This attack is used only on defense.
# drains            1     0     0     1     0     0     1     0     0     1   Half of inflicted damage is drained back up to maximum health.
# dread             1     0     1     0     1     1     1     1     1     1   When this attack is used offensively, this unit takes one third less damage in retaliation.
# evade             1     0     1     X     1     1     1     1     1     1   Unit takes one third less damage in retaliation.
# evasion           1     0     1     0     1     1     1     1     1     1   When this attack is used offensively, this unit takes one third less damage in retaliation.
# ferocious         1     0     1     1     0     0     0     0     1     1   This unit battles with such vigor that it always has at least a 60% chance to hit.
# firststrike       1     1     1     1     1     1     1     1     1     1   Attacks always first even on defense.
# focus             0     0     0     1     X     0     0     0     1     1   1,5x damage and 70% chance to hit on attack.
# guided            1     0     1     1     0     0     0     0     1     1   This units weapon chases after the enemy, and has a 70% chance to hit units of lower level.
# highground        1     0     0     1     0     1     1     1     0     1   This units skill with a bow is improved when he is able to fire down upon the enemy from high up, damage is increased by +1 for hills and villages, and +2 for mountains and castles, but decreased if your terrain is lower.
# magical           1     0     1     1     0     X     0     0     1     1   This attack has always 70% chance to hit.
# marksman          1     0     1     1     0     0     X     0     1     1   This attack has always 60% chance to hit.
# massivestrike     1     1     1     1     0     0     0     0     1     1   This attack always has a 20% chance to hit.
# nocounter         1     0     0     0     1     1     1     1     0     1   The opponent has always a 0% chance to hit, when this unit is attacking.
# poison            1     1     1     1     1     1     1     1     1     1   Affected unit loses 8 HP at start of turn until it drops to 1 HP.
# precision         1     0     1     1     0     0     0     0     1     1   This attack has always 80% chance to hit.
# rage              0     0     0     1     1     1     1     1     X     1   3 rounds of attacks
# rage2             0     0     0     1     1     1     1     1     X     1   3 rounds of attacks
# rage3             0     0     0     1     1     1     1     1     X     1   3 rounds of attacks
# recieve           1     1     1     1     1     1     1     1     1     1   When this unit is adjacent to a unit with Supply ability, it increases its ranged strikes by one, this does not stack.
# return            1     0     1     1     0     0     0     0     0     1   When this attack is used, this units gets an extra strike after each successful hit. Also because it is a generally difficult weapon to use, it has 10% less chance to hit. If this attack misses on offense before the other unit finishes attacking, this unit will hide and not get attacked any further.
# slow              1     0     1     1     1     1     1     1     1     X   When this attack hits, it slows opponent to cause half damage.
# spread            1     1     1     1     1     1     1     1     1     1   This unit will automatically disease any enemy adjacent to it at the beggining of its turn.
# triplestrike      0     0     0     1     1     1     1     1     0     1   This unit has 3 heads, and when it strikes its extra heads do 2 damage to any enemy units adjacent to both the attacker and defender.
# udbane            0     0     0     1     0     0     0     0     0     1   This attack cuts at the tie between an abomination and its corrupted source of animation.  This attack deals additional damage to the targets: aberration = 150%, undead = 140%, vampire = 120%
#
# 0 not allowed
# 1 allowed
# X equal special

# deprecated, replaced by SXC_ARMORY_LIMITS_AND_EMPTY_SIDES
#define SXC_ARMORY_LIMIT SIDE
  {VARIABLE sxc_side {SIDE}}
  [fire_event]
    name=sxc_armory_limits
  [/fire_event]
  {CLEAR_VARIABLE sxc_side}
#enddef

# Initial settings for player sides
#define SXC_ARMORY_LIMIT_EVENT
  [event]
    name=sxc_armory_limits
    first_time_only=no
    {VARIABLE melee_damage_$sxc_side 0}
    {VARIABLE ranged_damage_$sxc_side 0}
    {VARIABLE melee_strikes_$sxc_side 0}
    {VARIABLE ranged_strikes_$sxc_side 0}
    {VARIABLE movement_upgrades_$sxc_side 0}
    {VARIABLE black_potions_$sxc_side 0}
    {VARIABLE blue_potions_$sxc_side 0}
    {VARIABLE brown_potions_$sxc_side 0}
    {VARIABLE cyan_potions_$sxc_side 0}
    {VARIABLE grey_potions_$sxc_side 0}
    {VARIABLE green_potions_$sxc_side 0}
    {VARIABLE orange_potions_$sxc_side 0}
    {VARIABLE pink_potions_$sxc_side 0}
    {VARIABLE red_potions_$sxc_side 0}
    {VARIABLE violet_potions_$sxc_side 0}
    {VARIABLE white_potions_$sxc_side 0}
    {VARIABLE yellow_potions_$sxc_side 0}
    {VARIABLE potions_total_$sxc_side 0}
    {VARIABLE extra_armor_bought_$sxc_side 0}
    {VARIABLE hide_ranged_$sxc_side no}
    {VARIABLE hide_melee_$sxc_side no}
    {VARIABLE terrains_left_$sxc_side 2}
    {VARIABLE sxc_attack_specialization_$sxc_side "none"}
    {VARIABLE mc_castle_$sxc_side 0}
    {VARIABLE mc_cave_$sxc_side 0}
    {VARIABLE mc_deep_water_$sxc_side 0}
    {VARIABLE mc_flat_$sxc_side 0}
    {VARIABLE mc_forest_$sxc_side 0}
    {VARIABLE mc_frozen_$sxc_side 0}
    {VARIABLE mc_fungus_$sxc_side 0}
    {VARIABLE mc_hills_$sxc_side 0}
    {VARIABLE mc_impassable_$sxc_side 0}
    {VARIABLE mc_mountains_$sxc_side 0}
    {VARIABLE mc_reef_$sxc_side 0}
    {VARIABLE mc_sand_$sxc_side 0}
    {VARIABLE mc_shallow_water_$sxc_side 0}
    {VARIABLE mc_swamp_water_$sxc_side 0}
    {VARIABLE mc_unwalkable_$sxc_side 0}
    {VARIABLE mc_village_$sxc_side 0}
    {VARIABLE speedy_$sxc_side 0}
    {VARIABLE mp_kill_$sxc_side 4}
    {VARIABLE defring_$sxc_side 0}
    {VARIABLE resring_$sxc_side 0}
    {VARIABLE income_$sxc_side 0}
    {VARIABLE target_$sxc_side 0}
    {VARIABLE cloak_$sxc_side 0}
    {VARIABLE cornucopia_$sxc_side 0}
    {VARIABLE sceptre_$sxc_side 0}
    {VARIABLE sword_$sxc_side 0}
    {VARIABLE bow_$sxc_side 0}
    {VARIABLE necklace_$sxc_side 0}
    {VARIABLE icearmor_$sxc_side 0}
    {VARIABLE firearmor_$sxc_side 0}
    {VARIABLE spiritstaff_$sxc_side 0}
    {VARIABLE buckler_$sxc_side 0}
    {VARIABLE barrel_$sxc_side 0}
    {VARIABLE dwarvishplate_$sxc_side 0}
    {VARIABLE ringofdarkness_$sxc_side 0}
    {VARIABLE arcane_boost_$sxc_side 0}
    {VARIABLE blade_boost_$sxc_side 0}
    {VARIABLE cold_boost_$sxc_side 0}
    {VARIABLE fire_boost_$sxc_side 0}
    {VARIABLE impact_boost_$sxc_side 0}
    {VARIABLE pierce_boost_$sxc_side 0}
    {VARIABLE defense_boost_$sxc_side 0}
    {VARIABLE sxc_revive_mode "no"}
    {VARIABLE sxc_revive_cost 0}
    [set_variables]
      name=sxc_revive_dead
      mode=replace
      # This stores the units to revive next turn, at the start it's empty
    [/set_variables]
    [set_variables]
      name=sxc_revive_location
      mode=replace
      [value]
        x=999
        y=999
      [/value]
    [/set_variables]
    {SXC_CHECK_ARMOR_TOTAL $sxc_side}
    {SXC_UNIT_MOVEMENTS_RESTORE $sxc_side}
    {SXC_DISALLOW_RECRUITS $sxc_side}
  [/event]
#enddef

#define SXC_ABILITIES_REPLACEMENT SIDE
  [object]
    silent=yes
    duration=forever
    [filter]
      ability=dauntless
      side={SIDE}
    [/filter]
    [effect]
      apply_to=remove_ability
      [abilities]
        [regenerate]
          id=dauntless
        [/regenerate]
      [/abilities]
    [/effect]
    [effect]
      apply_to=new_ability
      [abilities]
        {ABILITY_SXC_DAUNTLESS}
      [/abilities]
    [/effect]
  [/object]
  [object]
    silent=yes
    duration=forever
    [filter]
      ability=leadership
      side={SIDE}
    [/filter]
    [effect]
      apply_to=remove_ability
      [abilities]
        [leadership]
          id=leadership
        [/leadership]
      [/abilities]
    [/effect]
    [effect]
      apply_to=new_ability
      [abilities]
        {ABILITY_SXC_LEADERSHIP}
      [/abilities]
    [/effect]
  [/object]
  [object]
    silent=yes
    duration=forever
    [filter]
      # Ageless Era 4.19 and before: AE_arc_healing,AE_mag_id_healing,AE_mag_id_healing_extra,AE_mag_id_heals12
      # Ageless Era 4.20: AE_mag_healing, AE_mag_healing_extra, AE_mag_healing5, AE_mag_heals12
      # Ageless Era 4.20 with filters: AE_mag_repair6,AE_mag_repair8,undeadheal5,undeadheal8
      # The undeadheal is a macro defined as undeadheal{VALUE}
      # All of the ones with filters will be turned in to minorcures instead of megacures
      ability=healing,AE_arc_healing,AE_mag_id_healing,AE_mag_id_healing_extra,AE_mag_id_heals12,AE_mag_healing,AE_mag_healing_extra,AE_mag_healing5,AE_mag_heals12
      side={SIDE}
      [not]
        [filter_wml]
          [abilities]
            [heals]
              value=2
            [/heals]
          [/abilities]
        [/filter_wml]
        [or]
          [filter_wml]
            [abilities]
              [heals]
                value=4
              [/heals]
            [/abilities]
          [/filter_wml]
        [/or]
        [or]
          [filter_wml]
            [abilities]
              [heals]
                value=6
              [/heals]
            [/abilities]
          [/filter_wml]
        [/or]
      [/not]
    [/filter]
    [effect]
      apply_to=remove_ability
      [abilities]
        [heals]
          id=healing
        [/heals]
        [heals]
          id=curing
        [/heals]
        # Ageless 4.19 and before
        [heals]
          id=AE_arc_healing
        [/heals]
        [heals]
          id=AE_mag_id_healing
        [/heals]
        [heals]
          id=AE_mag_id_healing_extra
        [/heals]
        [heals]
          id=AE_mag_id_heals12
        [/heals]
        [heals]
          id=AE_mag_id_curing
        [/heals]
        # Ageless 4.20
        [heals]
        id=AE_mag_healing
        [/heals]
        [heals]
        id=AE_mag_healing_extra
        [/heals]
        [heals]
        id=AE_mag_healing5
        [/heals]
        [heals]
        id=AE_mag_heals12
        [/heals]
        [heals]
        id=AE_mag_curing
        [/heals]
      [/abilities]
    [/effect]
    [effect]
      apply_to=new_ability
      [abilities]
        {ABILITY_SXC_MEGACURES}
      [/abilities]
    [/effect]
  [/object]
  [object]
    silent=yes
    duration=forever
    [filter]
      ability=healing,AE_arc_healing,AE_mag_id_healing,AE_mag_id_healing_extra,AE_mag_id_heals12,AE_mag_healing,AE_mag_healing_extra,AE_mag_healing5,AE_mag_heals12,AE_mag_repair6,AE_mag_repair8,undeadheal5,undeadheal8
      side={SIDE}
    [/filter]
    [effect]
      apply_to=remove_ability
      [abilities]
        [heals]
          id=healing
        [/heals]
        [heals]
          id=curing
        [/heals]
        # Ageless 4.19 and before
        [heals]
          id=AE_arc_healing
        [/heals]
        [heals]
          id=AE_mag_id_healing
        [/heals]
        [heals]
          id=AE_mag_id_healing_extra
        [/heals]
        [heals]
          id=AE_mag_id_heals12
        [/heals]
        [heals]
          id=AE_mag_id_curing
        [/heals]
        # Ageless 4.20
        [heals]
        id=AE_mag_healing
        [/heals]
        [heals]
        id=AE_mag_healing_extra
        [/heals]
        [heals]
        id=AE_mag_healing5
        [/heals]
        [heals]
        id=AE_mag_heals12
        [/heals]
        [heals]
        id=AE_mag_curing
        [/heals]
        [heals]
        id=AE_mag_repair6
        [/heals]
        [heals]
        id=AE_mag_repair8
        [/heals]
        [heals]
        id=undeadheal5
        [/heals]
        [heals]
        id=undeadheal8
        [/heals]
      [/abilities]
    [/effect]
    [effect]
      apply_to=new_ability
      [abilities]
        {ABILITY_SXC_MINORCURES}
      [/abilities]
    [/effect]
  [/object]
  [object]
    silent=yes
    duration=forever
    [filter]
      # Ageless Era 4.19 and before: AE_arc_selfheal,AE_stf_divine_health,AE_stf_divine_health_enhanced,AE_mag_id_regenerates4,AE_mag_id_regenerates12
      # Ageless Era 4.20: AE_mag_regenerates2,AE_mag_regenerates4,AE_mag_regenerates5,AE_mag_regenerates6,regen6,AE_mag_regenerates12
      # Some of those come from the AE_mag_regenerates{VALUE} macro
      # The ones that are less than 5hp are ignored (and the ones with the value hardcoded in the name are simply omitted from the lists of abilities to match)

      # Ageless Era 4.20 with filters (all of these are ignored by SXC)
      # id=AE_mag_regeneratessolar1_{VALUE}_{VALUE2}
      #         time_of_day_id=dawn,dusk
      # id=AE_mag_regeneratessolar2_{VALUE}_{VALUE2}
      #         time_of_day_id=morning,afternoon
      # id=AE_mag_regeneratesnight1_{VALUE}
      #         time_of_day_id=first_watch,second_watch,indoors,underground,deep_underground
      # id=AE_mag_water
      # id=AE_mag_funguslord{VALUE}

      ability=regenerates,AE_arc_selfheal,AE_stf_divine_health,AE_stf_divine_health_enhanced,AE_mag_id_regenerates12,AE_mag_regenerates5,AE_mag_regenerates6,regen6,AE_mag_regenerates12
      side={SIDE}
      [not]
        [filter_wml]
          [abilities]
            [regenerates]
              value=1
            [/regenerates]
          [/abilities]
        [/filter_wml]
        [or]
          [filter_wml]
            [abilities]
              [regenerates]
                value=2
              [/regenerates]
            [/abilities]
          [/filter_wml]
        [/or]
        [or]
          [filter_wml]
            [abilities]
              [regenerates]
                value=3
              [/regenerates]
            [/abilities]
          [/filter_wml]
        [/or]
        [or]
          [filter_wml]
            [abilities]
              [regenerates]
                value=4
              [/regenerates]
            [/abilities]
          [/filter_wml]
        [/or]
      [/not]
    [/filter]
    [effect]
      apply_to=remove_ability
      [abilities]
        [regenerate]
          id=regenerates
        [/regenerate]
        # Ageless 4.19 and before
        [regenerate]
          id=AE_arc_selfheal
        [/regenerate]
        [regenerate]
          id=AE_stf_divine_health
        [/regenerate]
        [regenerate]
          id=AE_stf_divine_health_enhanced
        [/regenerate]
        [regenerate]
          id=AE_mag_id_regenerates12
        [/regenerate]
        # Ageless 4.20
        [regenerate]
        id=AE_mag_regenerates5
        [/regenerate]
        [regenerate]
        id=AE_mag_regenerates6
        [/regenerate]
        [regenerate]
        id=regen6
        [/regenerate]
        [regenerate]
        id=AE_mag_regenerates12
        [/regenerate]
      [/abilities]
    [/effect]
    [effect]
      apply_to=new_ability
      [abilities]
        {ABILITY_SXC_MEGAREGENERATES}
      [/abilities]
    [/effect]
  [/object]
  [object]
    silent=yes
    duration=forever
    [filter]
      ability=feeding
      side={SIDE}
    [/filter]
    [effect]
      apply_to=remove_ability
      [abilities]
        [dummy]
          id=feeding
        [/dummy]
      [/abilities]
    [/effect]
    [effect]
      apply_to=new_ability
      [abilities]
        {ABILITY_SXC_SOULSTEALER}
      [/abilities]
    [/effect]
  [/object]
  [object]
    silent=yes
    duration=forever
    [filter]
      ability=steadfast
      side={SIDE}
    [/filter]
    [effect]
      apply_to=remove_ability
      [abilities]
        [dummy]
          id=steadfast
        [/dummy]
      [/abilities]
    [/effect]
    [effect]
      apply_to=new_ability
      [abilities]
        {ABILITY_SXC_STEADFAST}
      [/abilities]
    [/effect]
  [/object]
#enddef

#define SXC_MUSIC_PLAYLIST
  {SXC_MUSIC underground.ogg}
  {SXC_ADD_MUSIC knolls.ogg}
  {SXC_ADD_MUSIC northerners.ogg}
  {SXC_ADD_MUSIC elf-land.ogg}
  {SXC_ADD_MUSIC legends_of_the_north.ogg}
  {SXC_ADD_MUSIC wanderer.ogg}
  {SXC_ADD_MUSIC loyalists.ogg}
  {SXC_ADD_MUSIC revelation.ogg}

  [event]
    name=prestart
    {SXC_MUSIC underground.ogg}
    {SXC_ADD_MUSIC northerners.ogg}
    {SXC_ADD_MUSIC knolls.ogg}
    {SXC_ADD_MUSIC elf-land.ogg}
    {SXC_ADD_MUSIC legends_of_the_north.ogg}
    {SXC_ADD_MUSIC wanderer.ogg}
    {SXC_ADD_MUSIC loyalists.ogg}
    {SXC_ADD_MUSIC revelation.ogg}
  [/event]
#enddef

#define SXC_MUSIC FILE
  [music]
    name={FILE}
    ms_before=12000
    append=no
  [/music]
#enddef

#define SXC_ADD_MUSIC FILE
  [music]
    name={FILE}
    ms_before=12000
    append=yes
  [/music]
#enddef

#define SXC_PLAYER_SIDE_2 SIDE GOLD ADJUSTMENT
  [side]
    side={SIDE}
    team_name=Heroes
    canrecruit=yes
    controller=human
    income=-2
    village_gold=0
    fog=yes
    shroud=yes
    gold={GOLD}
    color_lock=true
    income_lock=true
    team_lock=true
    {ADJUSTMENT}
    [ai]
      passive_leader=yes
      village_value=-34.8
      aggression=0.0
      caution=1.0
      [aspect]
        id=recruitment_instructions
        [facet]
          [value]
            [recruit]
              importance=1
              number=0
            [/recruit]
          [/value]
        [/facet]
      [/aspect]
    [/ai]
    [modifications]
      [trait]
        id=sx
        name="sx"
        female_name="sx"
        description="Removes all forbidden abilities and attack specials
"
        [effect]
          apply_to=movement
          increase=1
        [/effect]
        [effect]
          apply_to=attack
          increase_damage=1
          increase_attacks=1
        [/effect]
        {SXC_TRAIT_EFFECTS}
      [/trait]
    [/modifications]
  [/side]
#enddef

#define SXC_TEST_PLAYER_SIDE_2 SIDE GOLD ADJUSTMENT
  [side]
    side={SIDE}
    team_name=Heroes
    canrecruit=yes
    controller=human
    income=-2
    village_gold=0
    fog=no
    shroud=no
    gold={GOLD}
    income_lock=true
    team_lock=true
    {ADJUSTMENT}
    [ai]
      passive_leader=no
      #     ai_algorithm=default
      village_value=-34.8
      aggression=0.0
      caution=1.0
    [/ai]
    [modifications]
      [trait]
        id=sx
        name="sx"
        female_name="sx"
        description="Removes all forbidden abilities and attack specials
"
        [effect]
          apply_to=movement
          increase=1
        [/effect]
        [effect]
          apply_to=attack
          increase_damage=1
          increase_attacks=1
        [/effect]
        {SXC_TRAIT_EFFECTS}
      [/trait]
    [/modifications]
  [/side]
#enddef

#define SXC_TRAIT_EFFECTS
  [effect]
    apply_to=attack
    remove_specials=stones,sculpts,AE_mag_id_sculpts,plague,plague(EOM_Bloodborn),plague(bliinfec),plague(bliseed),plague(blipara),plague(ifimp),plague(hivgnat),plague(Slavsav),plague(Slave),swarm,suicide,spores,latch,curse,BM New Zombie,BM Young Vampire,BM_cursed,plague(BM Bloodborn),CE_cursed,drains,circle,BM soulbind,plague(AE_agl_yokai_Swarm_Spawn),plague(AE_efm_pygmies_Lizard),plague(AE_efm_pygmies_Toad),plague(AE_ele_Skeletal_Corpse),plague(AE_ext_monsters_Baby_Mudcrawler),plague(AE_mrc_Blight_Infected),plague(AE_mrc_Blight_Parasite),plague(AE_mrc_hive_Gnat),plague(AE_mrc_infernai_Imp),plague(AE_mrc_slavers_Slave),plague(AE_myh_Bloodborn),plague(AE_rhy_de_Spiderling),AE_ele_fallen_drain0.125,AE_ele_fallen_drain0.15,AE_ele_fallen_drain0.2,AE_ele_fallen_drain0.20,AE_ele_fallen_drain0.25,AE_ele_fallen_drain0.33,AE_ele_fallen_drain0.40,AE_ele_fallen_drain0.50,AE_agl_steelhive_drain,
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon5_1rand
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=undead_summon6_1
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=undead_summon6_2
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon7_0
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon7_1
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon7_2
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon7_3
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=undead_summon7_1
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=undead_summon7_2
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon_lvl3
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon_lvl4
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=soultaker
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [hides]
        id=concealment
      [/hides]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [hides]
        id=ambush
      [/hides]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [hides]
        id=nightstalk
      [/hides]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [hides]
        id=submerge
      [/hides]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [teleport]
        id=teleport
      [/teleport]
    [/abilities]
  [/effect]
#enddef

#define SXC_CHECK_ARMOR_TOTAL SIDE
  [object]
    silent=yes
    duration=forever
    [filter]
      side={SIDE}
      canrecruit=yes
    [/filter]
    [effect]
      apply_to=attack
      range=melee
      type=energy
      set_type=fire
    [/effect]
    [effect]
      apply_to=attack
      range=ranged
      type=energy
      set_type=fire
    [/effect]
    [effect]
      apply_to=attack
      range=melee
      type=force
      set_type=impact
    [/effect]
    [effect]
      apply_to=attack
      range=ranged
      type=force
      set_type=impact
    [/effect]
  [/object]
  [store_unit]
    [filter]
      side={SIDE}
      canrecruit=yes
    [/filter]
    variable=leader_armor
  [/store_unit]
  {VARIABLE advanceto ",$leader_armor.advances_to|,"}
  {VARIABLE id ",$leader_armor.type|,"}
  {VARIABLE armor_index 180}
  {VARIABLE abilities_replace "no"}
  [if]
    {SXC_CMP maximum_level_reached_{SIDE} not_equals "yes"}
    [then]
      # Wesnoth's "resistance" value is the amount of damage taken, so what's shown to players as
      # +10% is represented by the value 90, and higher values mean the unit takes more damage.
      #
      # Using the normal player-visible res values, the calculations in this [then] take the
      # difference between +10% and the character's default, and reduce it to 1/3 of that
      # difference, rounded to the nearest 5%.
      #
      # So a default of 50% becomes 25% in SXC:
      # 50% = 10% + 40%, then 40/3 rounds to 15, so 10% + 15% = 25%
      {VARIABLE arcane_armor 90}
      {VARIABLE blade_armor 90}
      {VARIABLE cold_armor 90}
      {VARIABLE fire_armor 90}
      {VARIABLE impact_armor 90}
      {VARIABLE pierce_armor 90}
      {VARIABLE_OP arcane_armor sub $leader_armor.resistance.arcane}
      {VARIABLE_OP blade_armor sub $leader_armor.resistance.blade}
      {VARIABLE_OP cold_armor sub $leader_armor.resistance.cold}
      {VARIABLE_OP fire_armor sub $leader_armor.resistance.fire}
      {VARIABLE_OP impact_armor sub $leader_armor.resistance.impact}
      {VARIABLE_OP pierce_armor sub $leader_armor.resistance.pierce}
      {SXC_ROUND arcane_armor divide 15.0 0}
      {SXC_ROUND blade_armor divide 15.0 0}
      {SXC_ROUND cold_armor divide 15.0 0}
      {SXC_ROUND fire_armor divide 15.0 0}
      {SXC_ROUND impact_armor divide 15.0 0}
      {SXC_ROUND pierce_armor divide 15.0 0}
      {VARIABLE_OP arcane_armor multiply 5}
      {VARIABLE_OP blade_armor multiply 5}
      {VARIABLE_OP cold_armor multiply 5}
      {VARIABLE_OP fire_armor multiply 5}
      {VARIABLE_OP impact_armor multiply 5}
      {VARIABLE_OP pierce_armor multiply 5}
      [if]
        {SXC_CMP arcane_armor greater_than 0}
        [then]
          {VARIABLE_OP armor_index sub $arcane_armor}
        [/then]
      [/if]
      [if]
        {SXC_CMP blade_armor greater_than 0}
        [then]
          {VARIABLE_OP armor_index sub $blade_armor}
        [/then]
      [/if]
      [if]
        {SXC_CMP cold_armor greater_than 0}
        [then]
          {VARIABLE_OP armor_index sub $cold_armor}
        [/then]
      [/if]
      [if]
        {SXC_CMP fire_armor greater_than 0}
        [then]
          {VARIABLE_OP armor_index sub $fire_armor}
        [/then]
      [/if]
      [if]
        {SXC_CMP impact_armor greater_than 0}
        [then]
          {VARIABLE_OP armor_index sub $impact_armor}
        [/then]
      [/if]
      [if]
        {SXC_CMP pierce_armor greater_than 0}
        [then]
          {VARIABLE_OP armor_index sub $pierce_armor}
        [/then]
      [/if]
      {VARIABLE_OP arcane_armor sub 90}
      {VARIABLE_OP blade_armor sub 90}
      {VARIABLE_OP cold_armor sub 90}
      {VARIABLE_OP fire_armor sub 90}
      {VARIABLE_OP impact_armor sub 90}
      {VARIABLE_OP pierce_armor sub 90}
      {VARIABLE_OP arcane_armor multiply -1}
      {VARIABLE_OP blade_armor multiply -1}
      {VARIABLE_OP cold_armor multiply -1}
      {VARIABLE_OP fire_armor multiply -1}
      {VARIABLE_OP impact_armor multiply -1}
      {VARIABLE_OP pierce_armor multiply -1}
      [if]
        {SXC_CMP leader_armor.advances_to equals $null}
        [or]
          {SXC_CMP advanceto contains $id}
        [/or]
        [then]
          {VARIABLE armor_total_{SIDE} $armor_index}
          {VARIABLE armor_limit_{SIDE} 10}
          {VARIABLE maximum_level_reached_{SIDE} "yes"}
          {VARIABLE leader_armor.advances_to $null}
          {VARIABLE abilities_replace "yes"}
        [/then]
        [else]
          {VARIABLE leader_armor.resistance.arcane $arcane_armor}
          {VARIABLE leader_armor.resistance.blade $blade_armor}
          {VARIABLE leader_armor.resistance.cold $cold_armor}
          {VARIABLE leader_armor.resistance.fire $fire_armor}
          {VARIABLE leader_armor.resistance.impact $impact_armor}
          {VARIABLE leader_armor.resistance.pierce $pierce_armor}
          {VARIABLE maximum_level_reached_{SIDE} "no"}
        [/else]
      [/if]
    [/then]
  [/if]
  [unstore_unit]
    variable=leader_armor
  [/unstore_unit]
  [if]
    {SXC_CMP abilities_replace equals "yes"}
    [then]
      [object]
        silent=yes
        duration=forever
        [filter]
          side={SIDE}
          canrecruit=yes
        [/filter]
        [effect]
          apply_to=resistance
          replace=yes
          [resistance]
            arcane=$arcane_armor
            blade=$blade_armor
            cold=$cold_armor
            fire=$fire_armor
            impact=$impact_armor
            pierce=$pierce_armor
          [/resistance]
        [/effect]
      [/object]
      {SXC_ABILITIES_REPLACEMENT {SIDE}}
    [/then]
  [/if]
  {CLEAR_VARIABLE abilities_replace}
  {CLEAR_VARIABLE armor_index}
  {CLEAR_VARIABLE arcane_armor}
  {CLEAR_VARIABLE blade_armor}
  {CLEAR_VARIABLE cold_armor}
  {CLEAR_VARIABLE fire_armor}
  {CLEAR_VARIABLE impact_armor}
  {CLEAR_VARIABLE pierce_armor}
  {CLEAR_VARIABLE id}
  {CLEAR_VARIABLE advanceto}
  {CLEAR_VARIABLE leader_armor}
#enddef

#define SXC_UNIT_MOVEMENTS_RESTORE SIDE
  [store_unit]
    [filter]
      side={SIDE}
      canrecruit=yes
    [/filter]
    variable=unit_mc
  [/store_unit]
  {VARIABLE bad_terrains_left 0}
  [if]
    {SXC_CMP unit_mc.flying boolean_equals yes}
    [then]
      {SXC_TERRAIN_CHECK_MOVEMENT "deep_water" 1 {SIDE}}
      {SXC_TERRAIN_CHECK_MOVEMENT "unwalkable" 1 {SIDE}}
    [/then]
    [else]
      {SXC_TERRAIN_CHECK_MOVEMENT "deep_water" 3 {SIDE}}
      {SXC_TERRAIN_CHECK_MOVEMENT "unwalkable" 3 {SIDE}}
    [/else]
  [/if]
  {SXC_TERRAIN_CHECK_MOVEMENT "castle" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "cave" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "flat" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "forest" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "frozen" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "fungus" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "hills" 1 {SIDE}}
#   {SXC_TERRAIN_CHECK_MOVEMENT "impassable"}
  {SXC_TERRAIN_CHECK_MOVEMENT "mountains" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "reef" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "sand" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "shallow_water" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "swamp_water" 1 {SIDE}}
  {SXC_TERRAIN_CHECK_MOVEMENT "village" 1 {SIDE}}
  [unstore_unit]
    variable=unit_mc
  [/unstore_unit]
  [if]
    {SXC_CMP maximum_level_reached_{SIDE} equals "yes"}
    [and]
      {SXC_CMP bad_terrains_left greater_than 2}
    [/and]
    [then]
      {VARIABLE terrains_left_{SIDE} $bad_terrains_left}
      {VARIABLE_OP terrains_left_{SIDE} sub 2}
    [/then]
  [/if]
  {CLEAR_VARIABLE bad_terrains_left}
  {CLEAR_VARIABLE unit_mc}
#enddef

#define SXC_TERRAIN_CHECK_MOVEMENT MCVAR COST SIDE
  {VARIABLE defense_check $unit_mc.defense.{MCVAR}}
  {VARIABLE_OP defense_check add $defense_boost_{SIDE}}
  [if]
    {SXC_CMP defense_check less_than 0}
    [then]
      {VARIABLE defense_temp 0}
      {VARIABLE_OP defense_temp sub $defense_check}
      {VARIABLE defense_check $defense_temp}
      {CLEAR_VARIABLE defense_temp}
    [/then]
  [/if]
  [if]
    {SXC_CMP defense_check equals $null}
    [then]
      {VARIABLE defense_check 80}
    [/then]
  [/if]
  [if]
    {SXC_CMP defense_check numerical_equals 0}
    [then]
      {VARIABLE defense_check 80}
    [/then]
  [/if]
  [if]
    {SXC_CMP defense_check greater_than 60}
    [then]
      {VARIABLE defense_check 60}
    [/then]
  [/if]
  [if]
    {SXC_CMP defense_check less_than 20}
    [then]
      {VARIABLE defense_check 20}
    [/then]
  [/if]
  {VARIABLE_OP defense_check sub $defense_boost_{SIDE}}
  {VARIABLE unit_mc.defense.{MCVAR} $defense_check}
  {CLEAR_VARIABLE defense_check}
  [if]
    {SXC_CMP unit_mc.movement_costs.{MCVAR} equals $null}
    [then]
      {VARIABLE unit_mc.movement_costs.{MCVAR} 50}
    [/then]
  [/if]
  [if]
    {SXC_CMP mc_{MCVAR}_{SIDE} numerical_equals 1}
    [then]
      {VARIABLE unit_mc.movement_costs.{MCVAR} {COST}}
    [/then]
  [/if]
  [if]
    {SXC_CMP unit_mc.movement_costs.{MCVAR} greater_than {COST}}
    [then]
      {VARIABLE_OP bad_terrains_left add 1}
    [/then]
  [/if]
#enddef

# deprecated, replaced by SXC_ARMORY_LIMITS_AND_EMPTY_SIDES
#define SXC_NO_GOLD_FOR_NOBODY
  {VARIABLE i 1}
  [while]
    {SXC_CMP i less_than_equal_to 5}
    [do]
      [store_gold]
        side=$i
        variable=gold_trans
      [/store_gold]
      [if]
        [not]
          [have_unit]
            side=$i
            canrecruit=yes
          [/have_unit]
        [/not]
        [then]
          [gold]
            amount=-$gold_trans
            side=$i
          [/gold]
        [/then]
      [/if]
      {VARIABLE_OP i add 1}
    [/do]
  [/while]
  {CLEAR_VARIABLE i}
  {CLEAR_VARIABLE gold_trans}
#enddef

# This combines the old
#    {SXC_ARMORY_LIMIT 1}
#    {SXC_ARMORY_LIMIT 2}
#    {SXC_ARMORY_LIMIT 3}
#    {SXC_ARMORY_LIMIT 4}
#    {SXC_ARMORY_LIMIT 5}
#    {SXC_NO_GOLD_FOR_NOBODY}
# sequence, and only runs the sxc_armory_limits routine for sides that have a leader.
#define SXC_ARMORY_LIMITS_AND_EMPTY_SIDES
  {VARIABLE i 1}
  [while]
    {SXC_CMP i less_than_equal_to 5}
    [do]
      [store_gold]
        side=$i
        variable=gold_trans
      [/store_gold]
      [if]
          [have_unit]
            side=$i
            canrecruit=yes
          [/have_unit]
        [then]
          {VARIABLE sxc_side $i}
          [fire_event]
            name=sxc_armory_limits
          [/fire_event]
          {CLEAR_VARIABLE sxc_side}
        [/then]
        [else]
          [gold]
            amount=-$gold_trans
            side=$i
          [/gold]
        [/else]
      [/if]
      {VARIABLE_OP i add 1}
    [/do]
  [/while]
  {CLEAR_VARIABLE i}
  {CLEAR_VARIABLE gold_trans}
#enddef

#define SXC_BEFORE_SHOPS
  {VARIABLE shopxs 999}
  {VARIABLE shopys 999}
#enddef

#define SXC_PLACE_ITEM X Y IMAGE HALO
  {VARIABLE halo {HALO}}
  [if]
    {SXC_CMP halo not_equals ""}
    [then]
      [item]
        x,y={X},{Y}
        image={IMAGE}
        halo={HALO}
      [/item]
    [/then]
    [else]
      [item]
        x,y={X},{Y}
        image={IMAGE}
      [/item]
    [/else]
  [/if]
#enddef

#define SXC_REDRAW_ITEMS X Y
  [remove_item]
    x,y={X},{Y}
  [/remove_item]
  {FOREACH item i}
    [if]
      {SXC_CMP item[$i|].x equals {X}}
      {SXC_CMP item[$i|].y equals {Y}}
      {SXC_CMP item[$i|].used equals 0}
      [then]
        {SXC_PLACE_ITEM {X} {Y} $item[$i|].image $item[$i|].halo}
      [/then]
    [/if]
  {NEXT i}
#enddef

#define SXC_ITEM X Y ITEM IMAGE HALO
  {VARIABLE n $item.length}
  {VARIABLE item[$n].x {X}}
  {VARIABLE item[$n].y {Y}}
  {VARIABLE item[$n].type {ITEM}}
  {VARIABLE item[$n].image {IMAGE}}
  {VARIABLE item[$n].halo {HALO}}
  {VARIABLE item[$n].used 0}
  {SXC_PLACE_ITEM {X} {Y} {IMAGE} {HALO}}
  {CLEAR_VARIABLE n}
#enddef

#define SXC_SHOP_2 X Y IMAGE
  {SXC_ITEM {X} {Y} "SHOP" {IMAGE} ""}
  {VARIABLE shopxs $shopxs|,{X}}
  {VARIABLE shopys $shopys|,{Y}}

  [event]
    name=side turn
    first_time_only=no
    [label]
      x={X}
      y={Y}
      text="{X},{Y}"
    [/label]
    [label]
      x={X}
      y={Y}
      text="Shop"
    [/label]
  [/event]
#enddef

#define SXC_SHOP_EVENT
  [event]
    name=moveto
    first_time_only=no
    [filter]
      [filter_side]
        team_name=Heroes
      [/filter_side]
      x=$shopxs
      y=$shopys
      canrecruit=yes
    [/filter]
    [store_gold]
      side=$side_number
      variable=gold
    [/store_gold]
    [if]
      {SXC_CMP shopped_$side_number numerical_not_equals 1}
      [then]
        [message]
          speaker=narrator
          message="<span color='#FF2020' size='x-large' weight='bold'>To access shop menu, please right-click
on your unit standing at shop and then
click 'Enter shop' line in menu.</span>"
          [option]
            message="I wish to see this message again next time I'll step on shop"
            [command]
            [/command]
          [/option]
          [option]
            message="Ok. I don't want to see this message again"
            [command]
              {VARIABLE shopped_$side_number 1}
            [/command]
          [/option]
          image=wesnoth-icon.png
        [/message]
      [/then]
    [/if]
    [if]
      {SXC_CMP gold greater_than_equal_to 500}
      [then]
        {VARIABLE warning "
Shopping can take some time..."}
      [/then]
      [else]
        {VARIABLE warning ""}
      [/else]
    [/if]
    [print]
      text="Player $side_number stands at shop with $gold gold.$warning"
      size=18
      duration=500
      red,green,blue=255,176,0
    [/print]
    {CLEAR_VARIABLE warning}
    {CLEAR_VARIABLE gold}
    [redraw]
    [/redraw]
  [/event]

  {SXC_SHOP_MENU}
  {SXC_INVENTORY}
  {SXC_ITEM_EVENT}
  {SXC_ABILITY_EVENTS}
  {SXC_CLEAR_LABEL}
#enddef

#define SXC_CLEAR_LABEL
  [set_menu_item]
    id=SXC_Label
    description="Clear label here"
    [show_if]
      [have_unit]
        side=$side_number
        canrecruit=yes
      [/have_unit]
    [/show_if]
    [command]
      [label]
        x=$x1
        y=$y1
        text=""
      [/label]
    [/command]
  [/set_menu_item]
#enddef

#define SXC_SHOP_MENU
  [set_menu_item]
    id=SXC_Shop
    description="Enter Shop"
    image=icons/signpost_icon.png
    [show_if]
      [have_unit]
        side=$side_number
        x,y=$shopxs,$shopys
        canrecruit=yes
      [/have_unit]
      [have_unit]
        side=$side_number
        x,y=$x1,$y1
        canrecruit=yes
      [/have_unit]
    [/show_if]
    [command]
      [sound]
        name=shop_door_bell.ogg
      [/sound]
      {VARIABLE finished no}
      {VARIABLE healed no}
      [store_gold]
        side=$side_number
        variable=start_gold
      [/store_gold]
      [while]
        {SXC_CMP finished equals no}
        [do]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [message]
            speaker=narrator
            message="<span color='#FF8000' weight='bold'>In shop you can buy or sell stuff. Most of
shopping actions can be canceled, but only
until you will leave selected shop section.</span>
<span color='#E0E018'>Gold: $gold|</span>"
            image="scenery/signpost.png"
            [option]
              message={MENU_IMG_TXT "icons/leave.png" "<span weight='bold' size='large'>Leave shop</span>"}
              [command]
                {VARIABLE finished "yes"}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/heal.png" "<span color='#00FF00' weight='bold' size='large'>20 gold: Restore full HP</span>"}
              [show_if]
                {SXC_CMP healed equals no}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 20}
                  [then]
                    [gold]
                      amount=-20
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=hitpoints
                        increase_total=0
                        heal_full=yes
                      [/effect]
                      [effect]
                        apply_to=status
                        remove=poisoned
                      [/effect]
                      [effect]
                        apply_to=status
                        remove=slowed
                      [/effect]
                    [/object]
                  [/then]
                [/if]
                {CLEAR_VARIABLE healed}
              [/command]
            [/option]
            {SXC_SHOP_ENHANCEMENTS}
            {SXC_SHOP_WEAPONS}
            {SXC_SHOP_SPECIALS}
            {SXC_SHOP_ARMORY}
            {SXC_SHOP_MOVEMENTS}
            {SXC_SHOP_ABILITIES}
            {SXC_SHOP_ITEMS}
          [/message]
          [redraw]
          [/redraw]
        [/do]
      [/while]
      [if]
        {SXC_CMP gold less_than $start_gold}
        [then]
          {VARIABLE shopped_$side_number 1}
        [/then]
      [/if]
      {CLEAR_VARIABLE healed}
      {CLEAR_VARIABLE gold}
      {CLEAR_VARIABLE finished}
      {CLEAR_VARIABLE start_gold}
    [/command]
  [/set_menu_item]
#enddef

#define SXC_SHOP_ENHANCEMENTS
  [option]
    message={MENU_IMG_TXT "icons/enhancements-small.png" "<span color='#0040FF' weight='bold' size='large'>Enhancements</span>"}
    [command]
      {VARIABLE finished_sub no}
      {VARIABLE melee_damage 0}
      {VARIABLE ranged_damage 0}
      {VARIABLE melee_strikes 0}
      {VARIABLE ranged_strikes 0}
      {VARIABLE health_points 0}
      {VARIABLE movement_points 0}
      {VARIABLE melee_damage_gold 0}
      {VARIABLE ranged_damage_gold 0}
      {VARIABLE melee_strikes_gold 0}
      {VARIABLE ranged_strikes_gold 0}
      {VARIABLE health_points_gold 0}
      {VARIABLE movement_points_gold 0}
      [while]
        {SXC_CMP finished_sub equals no}
        [do]
          [store_unit]
            [filter]
              side=$side_number
              x,y=$x1,$y1
              canrecruit=yes
            [/filter]
            variable=enhancements
          [/store_unit]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          {VARIABLE moveleft $enhancements.max_moves}
          {VARIABLE_OP moveleft sub $movement_upgrades_$side_number}
          {VARIABLE_OP moveleft sub $speedy_$side_number}
          {VARIABLE movement_price $moveleft}
          [if]
            {SXC_CMP maximum_level_reached_$side_number equals "yes"}
            [then]
              {SXC_ROUND moveleft divide 1.5 floor}
              {VARIABLE_OP moveleft add 16}
              [if]
                {SXC_CMP moveleft greater_than 24}
                [then]
                  {VARIABLE moveleft 24}
                [/then]
              [/if]
              {VARIABLE_OP moveleft add $speedy_$side_number}
            [/then]
            [else]
              {VARIABLE_OP moveleft add 8}
              [if]
                {SXC_CMP moveleft greater_than 20}
                [then]
                  {VARIABLE moveleft 20}
                [/then]
              [/if]
            [/else]
          [/if]
          {VARIABLE_OP moveleft sub $enhancements.max_moves}
          {SXC_ROUND movement_price divide 1.5 floor}
          {VARIABLE_OP movement_price multiply (-1)}
          {VARIABLE_OP movement_price add $enhancements.max_moves}
          {VARIABLE_OP movement_price sub $speedy_$side_number}
          {VARIABLE_OP movement_price add 3}
          {VARIABLE_OP movement_price multiply 5}
          {VARIABLE four_movements_price 4}
          {VARIABLE_OP four_movements_price multiply $movement_price}
          {VARIABLE_OP four_movements_price add 15}
          {VARIABLE str_price_melee $melee_strikes_$side_number}
          {VARIABLE_OP str_price_melee add 7}
          {VARIABLE_OP str_price_melee multiply 10}
          {VARIABLE str_price_3melee $str_price_melee}
          {VARIABLE_OP str_price_3melee multiply 3}
          {VARIABLE_OP str_price_3melee add 15}
          {VARIABLE str_price_ranged $ranged_strikes_$side_number}
          {VARIABLE_OP str_price_ranged add 7}
          {VARIABLE_OP str_price_ranged multiply 10}
          {VARIABLE str_price_3ranged $str_price_ranged}
          {VARIABLE_OP str_price_3ranged multiply 3}
          {VARIABLE_OP str_price_3ranged add 15}
          {VARIABLE choose_range ""}
          [switch]
            variable=sxc_attack_specialization_$side_number
            [case]
              value="melee"
                {VARIABLE dmg_price_melee 20}
                {VARIABLE dmg_price_5melee 90}
                {VARIABLE_OP str_price_ranged multiply 2}
                {VARIABLE_OP str_price_3ranged multiply 2}
                {VARIABLE dmg_price_ranged 40}
                {VARIABLE dmg_price_5ranged 180}
            [/case]
            [case]
              value="ranged"
                {VARIABLE_OP str_price_melee multiply 2}
                {VARIABLE_OP str_price_3melee multiply 2}
                {VARIABLE dmg_price_melee 40}
                {VARIABLE dmg_price_5melee 180}
                {VARIABLE dmg_price_ranged 20}
                {VARIABLE dmg_price_5ranged 90}
            [/case]
            [else]
              # sxc_attack_specialization_$side_number is "none"

              # The lua code does a rough translation of "Melee or ranged" using core Wesnoth's translated strings
              [lua]
                  code=<<
                      local _ = wesnoth.textdomain "wesnoth"
                      local empty_str = ""
                      local ranges = { _ "melee", _ "ranged" }
                      wesnoth.set_variable ("sxc_l10n_header", wesnoth.format_disjunct_list(empty_str, ranges))
                  >>
              [/lua]
              {VARIABLE choose_range "<span color='#FF2020' weight='bold'>$sxc_l10n_header</span>
Before you will be able to buy damage and strikes training, you must choose
which range training you will focus on.  The other range will be much more
expensive to improve, it will cost the double price of the selected range.
"}
              {CLEAR_VARIABLE sxc_l10n_header}
            [/else]
          [/switch]
          [message]
            speaker=narrator
            message="<span color='#40C020' size='x-large' weight='bold'>Enhancements</span>
<span weight='bold'>Here you can buy training, that will teach your unit to do
more damage, attack faster and increase health and movement.</span>
$choose_range|<span color='#E0E018'>Gold: $gold|</span>
<span color='#8080FF'>Movement trainings left: $moveleft|</span>"
            image="icons/enhancements.png"
            [option]
              message={MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub "yes"}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals no}
                {SXC_CMP hide_ranged_$side_number equals no}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-melee.png" "<span color='#FF9060'>Hide melee upgrades</span>"}
              [command]
                {VARIABLE hide_melee_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals yes}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-melee.png" "<span color='#60C060'>Show melee upgrades</span>"}
              [command]
                {VARIABLE hide_melee_$side_number no}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_attack_specialization_$side_number equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-melee.png" ("<span color='#FF2020'>" + _ "melee" + ":</span> I will focus on melee training")}
              [command]
                {VARIABLE sxc_attack_specialization_$side_number "melee"}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP melee_damage numerical_not_equals 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-melee.png" "<span color='#FF8080'>+$melee_damage_gold| gold: Cancel Melee Damage training (-$melee_damage|)</span>"}
              [command]
                [gold]
                  amount=$melee_damage_gold
                  side=$side_number
                [/gold]
                [object]
                  silent=yes
                  duration=forever
                  [effect]
                    apply_to=attack
                    range=melee
                    increase_damage=-$melee_damage
                  [/effect]
                [/object]
                {VARIABLE_OP melee_damage_$side_number sub $melee_damage}
                {VARIABLE melee_damage 0}
                {VARIABLE melee_damage_gold 0}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals no}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-melee.png" "<span color='#80FF80' >$dmg_price_melee| gold: +1 Melee Damage</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $dmg_price_melee}
                  [then]
                    [gold]
                      amount=-$dmg_price_melee
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=melee
                        increase_damage=1
                      [/effect]
                    [/object]
                    {VARIABLE_OP melee_damage_$side_number add 1}
                    {VARIABLE_OP melee_damage add 1}
                    {VARIABLE_OP melee_damage_gold add $dmg_price_melee}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals no}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-melee.png" "<span color='#80FF80'>$dmg_price_5melee| gold: +5 Melee Damage</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $dmg_price_5melee}
                  [then]
                    [gold]
                      amount=-$dmg_price_5melee
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=melee
                        increase_damage=5
                      [/effect]
                    [/object]
                    {VARIABLE_OP melee_damage_$side_number add 5}
                    {VARIABLE_OP melee_damage add 5}
                    {VARIABLE_OP melee_damage_gold add $dmg_price_5melee}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP melee_strikes numerical_not_equals 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/strikes-melee.png" "<span color='#FF8080'>+$melee_strikes_gold| gold: Cancel Melee Strikes training (-$melee_strikes|)</span>"}
              [command]
                [gold]
                  amount=$melee_strikes_gold
                  side=$side_number
                [/gold]
                [object]
                  silent=yes
                  duration=forever
                  [effect]
                    apply_to=attack
                    range=melee
                    increase_attacks=-$melee_strikes
                  [/effect]
                [/object]
                {VARIABLE_OP melee_strikes_$side_number sub $melee_strikes}
                {VARIABLE melee_strikes 0}
                {VARIABLE melee_strikes_gold 0}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals no}
                {SXC_CMP melee_strikes_$side_number less_than 12}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/strikes-melee.png" "<span color='#80FF80'>$str_price_melee| gold: +1 Melee Strikes</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $str_price_melee}
                  [then]
                    [gold]
                      amount=-$str_price_melee
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=melee
                        increase_attacks=1
                      [/effect]
                    [/object]
                    {VARIABLE_OP melee_strikes_$side_number add 1}
                    {VARIABLE_OP melee_strikes add 1}
                    {VARIABLE_OP melee_strikes_gold add $str_price_melee}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals no}
                {SXC_CMP melee_strikes_$side_number less_than 10}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/strikes-melee.png" "<span color='#80FF80'>$str_price_3melee| gold: +3 Melee Strikes</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $str_price_3melee}
                  [then]
                    [gold]
                      amount=-$str_price_3melee
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=melee
                        increase_attacks=3
                      [/effect]
                    [/object]
                    {VARIABLE_OP melee_strikes_$side_number add 3}
                    {VARIABLE_OP melee_strikes add 3}
                    {VARIABLE_OP melee_strikes_gold add $str_price_3melee}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals no}
                {SXC_CMP hide_ranged_$side_number equals no}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-ranged.png" "<span color='#FF9060'>Hide ranged upgrades</span>"}
              [command]
                {VARIABLE hide_ranged_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_ranged_$side_number equals yes}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-ranged.png" "<span color='#60C060'>Show ranged upgrades</span>"}
              [command]
                {VARIABLE hide_ranged_$side_number no}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_attack_specialization_$side_number equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-ranged.png" ("<span color='#FF2020'>" + _ "ranged" + ":</span> I will focus on ranged training")}
              [command]
                {VARIABLE sxc_attack_specialization_$side_number "ranged"}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP ranged_damage numerical_not_equals 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-ranged.png" "<span color='#FF8080'>+$ranged_damage_gold| gold: Cancel Ranged Damage training (-$ranged_damage|)</span>"}
              [command]
                [gold]
                  amount=$ranged_damage_gold
                  side=$side_number
                [/gold]
                [object]
                  silent=yes
                  duration=forever
                  [effect]
                    apply_to=attack
                    range=ranged
                    increase_damage=-$ranged_damage
                  [/effect]
                [/object]
                {VARIABLE_OP ranged_damage_$side_number sub $ranged_damage}
                {VARIABLE ranged_damage 0}
                {VARIABLE ranged_damage_gold 0}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_ranged_$side_number equals no}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-ranged.png" "<span color='#80FF80'>$dmg_price_ranged| gold: +1 Ranged Damage</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $dmg_price_ranged}
                  [then]
                    [gold]
                      amount=-$dmg_price_ranged
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=ranged
                        increase_damage=1
                      [/effect]
                    [/object]
                    {VARIABLE_OP ranged_damage_$side_number add 1}
                    {VARIABLE_OP ranged_damage add 1}
                    {VARIABLE_OP ranged_damage_gold add $dmg_price_ranged}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_ranged_$side_number equals no}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-ranged.png" "<span color='#80FF80'>$dmg_price_5ranged| gold: +5 Ranged Damage</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $dmg_price_5ranged}
                  [then]
                    [gold]
                      amount=-$dmg_price_5ranged
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=ranged
                        increase_damage=5
                      [/effect]
                    [/object]
                    {VARIABLE_OP ranged_damage_$side_number add 5}
                    {VARIABLE_OP ranged_damage add 5}
                    {VARIABLE_OP ranged_damage_gold add $dmg_price_5ranged}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP ranged_strikes numerical_not_equals 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/strikes-ranged.png" "<span color='#FF8080'>+$ranged_strikes_gold| gold: Cancel Ranged Strikes training (-$ranged_strikes|)</span>"}
              [command]
                [gold]
                  amount=$ranged_strikes_gold
                  side=$side_number
                [/gold]
                [object]
                  silent=yes
                  duration=forever
                  [effect]
                    apply_to=attack
                    range=ranged
                    increase_attacks=-$ranged_strikes
                  [/effect]
                [/object]
                {VARIABLE_OP ranged_strikes_$side_number sub $ranged_strikes}
                {VARIABLE ranged_strikes 0}
                {VARIABLE ranged_strikes_gold 0}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_ranged_$side_number equals no}
                {SXC_CMP ranged_strikes_$side_number less_than 12}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/strikes-ranged.png" "<span color='#80FF80'>$str_price_ranged| gold: +1 Ranged Strikes</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $str_price_ranged}
                  [then]
                    [gold]
                      amount=-$str_price_ranged
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=ranged
                        increase_attacks=1
                      [/effect]
                    [/object]
                    {VARIABLE_OP ranged_strikes_$side_number add 1}
                    {VARIABLE_OP ranged_strikes add 1}
                    {VARIABLE_OP ranged_strikes_gold add $str_price_ranged}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_ranged_$side_number equals no}
                {SXC_CMP ranged_strikes_$side_number less_than 10}
                {SXC_CMP sxc_attack_specialization_$side_number not_equals "none"}
              [/show_if]
              message={MENU_IMG_TXT "icons/strikes-ranged.png" "<span color='#80FF80'>$str_price_3ranged| gold: +3 Ranged Strikes</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $str_price_3ranged}
                  [then]
                    [gold]
                      amount=-$str_price_3ranged
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=ranged
                        increase_attacks=3
                      [/effect]
                    [/object]
                    {VARIABLE_OP ranged_strikes_$side_number add 3}
                    {VARIABLE_OP ranged_strikes add 3}
                    {VARIABLE_OP ranged_strikes_gold add $str_price_3ranged}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP health_points numerical_not_equals 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/health5.png" "<span color='#FF8080'>+$health_points_gold| gold: Cancel HP upgrade (-$health_points|)</span>"}
              [command]
                [gold]
                  amount=$health_points_gold
                  side=$side_number
                [/gold]
                [object]
                  duration=forever
                  [effect]
                    apply_to=hitpoints
                    increase_total=-$health_points
                    violate_maximum=yes
                  [/effect]
                  [effect]
                    apply_to=hitpoints
                    increase=-$health_points
                    violate_maximum=yes
                  [/effect]
                  silent=yes
                [/object]
                {VARIABLE health_points 0}
                {VARIABLE health_points_gold 0}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/health5.png" "<span color='#80FF80'>10 gold: +5 Max. HP</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 10}
                  [then]
                    [gold]
                      amount=-10
                      side=$side_number
                    [/gold]
                    [object]
                      duration=forever
                      [effect]
                        apply_to=hitpoints
                        increase_total=5
                        violate_maximum=yes
                      [/effect]
                      [effect]
                        apply_to=hitpoints
                        increase=5
                        violate_maximum=yes
                      [/effect]
                      silent=yes
                    [/object]
                    {VARIABLE_OP health_points add 5}
                    {VARIABLE_OP health_points_gold add 10}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/health50.png" "<span color='#80FF80'>90 gold: +50 Max. HP</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 90}
                  [then]
                    [gold]
                      amount=-90
                      side=$side_number
                    [/gold]
                    [object]
                      duration=forever
                      [effect]
                        apply_to=hitpoints
                        increase_total=50
                        violate_maximum=yes
                      [/effect]
                      [effect]
                        apply_to=hitpoints
                        increase=50
                        violate_maximum=yes
                      [/effect]
                      silent=yes
                    [/object]
                    {VARIABLE_OP health_points add 50}
                    {VARIABLE_OP health_points_gold add 90}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movement_points numerical_not_equals 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/movement.png" "<span color='#FF8080'>+$movement_points_gold| gold: Cancel Movement upgrade (-$movement_points|)</span>"}
              [command]
                [gold]
                  amount=$movement_points_gold
                  side=$side_number
                [/gold]
                [store_unit]
                  [filter]
                    x,y=$x1,$y1
                    side=$side_number
                  [/filter]
                  variable=moveshop
                [/store_unit]
                {VARIABLE_OP moveshop.moves sub $movement_points}
                [unstore_unit]
                  variable=moveshop
                [/unstore_unit]
                {CLEAR_VARIABLE moveshop}
                [object]
                  silent=yes
                  duration=forever
                  [effect]
                    apply_to=movement
                    increase=-$movement_points
                  [/effect]
                [/object]
                {VARIABLE_OP movement_upgrades_$side_number add -$movement_points}
                {VARIABLE movement_points 0}
                {VARIABLE movement_points_gold 0}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/movement.png" "<span color='#80FF80'>$movement_price| gold: +1 Movement Point</span>"}
              [show_if]
                {SXC_CMP moveleft greater_than 0}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $movement_price}
                  [then]
                    [gold]
                      amount=-$movement_price
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=movement
                        increase=1
                      [/effect]
                    [/object]
                    [store_unit]
                      [filter]
                        x,y=$x1,$y1
                        side=$side_number
                      [/filter]
                      variable=moveshop
                    [/store_unit]
                    {VARIABLE_OP moveshop.moves add 1}
                    [unstore_unit]
                      variable=moveshop
                    [/unstore_unit]
                    {CLEAR_VARIABLE moveshop}
                    {VARIABLE_OP movement_upgrades_$side_number add 1}
                    {VARIABLE_OP movement_points add 1}
                    {VARIABLE_OP movement_points_gold add $movement_price}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/movement.png" "<span color='#80FF80'>$four_movements_price| gold: +4 Movement Points</span>"}
              [show_if]
                {SXC_CMP moveleft greater_than 3}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $four_movements_price}
                  [then]
                    [gold]
                      amount=-$four_movements_price
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=movement
                        increase=4
                      [/effect]
                    [/object]
                    [store_unit]
                      [filter]
                        x,y=$x1,$y1
                        side=$side_number
                      [/filter]
                      variable=moveshop
                    [/store_unit]
                    {VARIABLE_OP moveshop.moves add 4}
                    [unstore_unit]
                      variable=moveshop
                    [/unstore_unit]
                    {CLEAR_VARIABLE moveshop}
                    {VARIABLE_OP movement_upgrades_$side_number add 4}
                    {VARIABLE_OP movement_points add 4}
                    {VARIABLE_OP movement_points_gold add $four_movements_price}
                  [/then]
                [/if]
              [/command]
            [/option]
          [/message]
          [redraw]
          [/redraw]
          {CLEAR_VARIABLE moveleft}
          {CLEAR_VARIABLE movement_price}
          {CLEAR_VARIABLE four_movements_price}
          {CLEAR_VARIABLE enhancements}
          {CLEAR_VARIABLE str_price_melee}
          {CLEAR_VARIABLE str_price_3melee}
          {CLEAR_VARIABLE str_price_ranged}
          {CLEAR_VARIABLE str_price_3ranged}
          {CLEAR_VARIABLE dmg_price_melee}
          {CLEAR_VARIABLE dmg_price_5melee}
          {CLEAR_VARIABLE dmg_price_ranged}
          {CLEAR_VARIABLE dmg_price_5ranged}
          {CLEAR_VARIABLE choose_range}
        [/do]
      [/while]
      {CLEAR_VARIABLE melee_damage}
      {CLEAR_VARIABLE ranged_damage}
      {CLEAR_VARIABLE melee_strikes}
      {CLEAR_VARIABLE ranged_strikes}
      {CLEAR_VARIABLE health_points}
      {CLEAR_VARIABLE movement_points}
      {CLEAR_VARIABLE melee_damage_gold}
      {CLEAR_VARIABLE ranged_damage_gold}
      {CLEAR_VARIABLE melee_strikes_gold}
      {CLEAR_VARIABLE ranged_strikes_gold}
      {CLEAR_VARIABLE health_points_gold}
      {CLEAR_VARIABLE movement_points_gold}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SXC_SHOP_WEAPONS
  [option]
    message={MENU_IMG_TXT "icons/weapons-small.png" "<span color='#FF0000' weight='bold' size='large'>Weapons</span>"}
    [command]
      {VARIABLE weapons_bought "nothing,"}
      {VARIABLE finished_sub no}
      [while]
        {SXC_CMP finished_sub equals no}
        [do]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [store_unit]
            [filter]
              side=$side_number
              x,y=$x1,$y1
              canrecruit=yes
            [/filter]
            variable=weapons
          [/store_unit]
          {VARIABLE weapon_j 0}
          {FOREACH weapons.attack weapon_i}
            {VARIABLE name ",$weapons.attack[$weapon_i|].name|,"}
            {VARIABLE name_$weapon_j $weapons.attack[$weapon_i|].name}
            {VARIABLE range_$weapon_j $weapons.attack[$weapon_i|].range}
            {VARIABLE type_$weapon_j $weapons.attack[$weapon_i|].type}
            {VARIABLE damage $weapons.attack[$weapon_i|].damage}
            {VARIABLE_OP damage sub $$weapons.attack[$weapon_i|].range|_damage_$side_number}
            {VARIABLE number $weapons.attack[$weapon_i|].number}
            {VARIABLE_OP number sub $$weapons.attack[$weapon_i|].range|_strikes_$side_number}
            [if]
              {SXC_CMP weapons_bought contains $name}
              [then]
                {VARIABLE price_$weapon_j 40}
              [/then]
              [else]
                {SXC_IDENTIFY_SPECIALS weapons.attack[$weapon_i|].specials $weapon_j|}
                {VARIABLE price_$weapon_j $damage}
                {VARIABLE_OP price_$weapon_j multiply $number}
                {VARIABLE_OP price_$weapon_j multiply $$weapons.attack[$weapon_i|].type}
                {VARIABLE_OP price_$weapon_j multiply $$weapons.attack[$weapon_i|].range}
                {SXC_ROUND price_$weapon_j add $specials_price_$weapon_j 0}
              [/else]
            [/if]
            {VARIABLE sell_text_$weapon_j "+$price_$weapon_j|| gold: sell $weapons.attack[$weapon_i|].description|: $weapons.attack[$weapon_i|].range| $weapons.attack[$weapon_i|].type| $damage| - $number|$specials_list_$weapon_j|"}
            {VARIABLE_OP weapon_j add 1}
            {CLEAR_VARIABLE name}
            {CLEAR_VARIABLE damage}
            {CLEAR_VARIABLE number}
          {NEXT weapon_i}
          [message]
            speaker=narrator
            message="<span color='#40C020' size='x-large' weight='bold'>Weapons</span>
<span weight='bold'>You can buy only basic weapons here. Specials can be bought
separately in Weapon specials section. You can have maximum
of 8 weapons at a time. You can also sell any weapon you have
(your unit related weapons can only be sold after reaching
maximum level for your unit).</span>
<span color='#E0E018'>Gold: $gold|</span>"
            image="icons/weapons.png"
            [option]
              message={MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub "yes"}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals no}
                {SXC_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-melee.png" "<span color='#FF9060'>Hide melee weapons</span>"}
              [command]
                {VARIABLE hide_melee_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals yes}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-melee.png" "<span color='#60C060'>Show melee weapons</span>"}
              [command]
                {VARIABLE hide_melee_$side_number no}
              [/command]
            [/option]
            {SXC_BUY_WEAPON "icons/blessed-sword.png" (blessed sword) blessed_sword melee arcane 7 4 "attacks/sword-holy.png" {SOUND_LIST:SWORD_SWISH},{SOUND_LIST:HOLY} {SOUND_LIST:HOLY_MISS}}
            {SXC_BUY_WEAPON "icons/iron-sword.png" (iron sword) iron_sword melee blade 11 5 "attacks/sword-human.png" {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS}}
            {SXC_BUY_WEAPON "icons/ice-sword.png" (ice sword) ice_sword melee cold 11 4 "attacks/astral-blade.png" {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS}}
            {SXC_BUY_WEAPON "icons/flaming-sword.png" (flaming sword) "flaming_sword" melee fire 9 4 "attacks/sword-flaming.png" {SOUND_LIST:SWORD_SWISH},flame-big.ogg {SOUND_LIST:MISS},flame-big-miss.ogg}
            {SXC_BUY_WEAPON "icons/mace.png" (mace) mace melee impact 17 3 "attacks/mace.png" mace.wav {SOUND_LIST:MISS}}
            {SXC_BUY_WEAPON "icons/spear.png" (spear) spear melee pierce 13 4 "attacks/spear.png" spear.ogg spear-miss.ogg}
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals no}
                {SXC_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-ranged.png" "<span color='#FF9060'>Hide ranged weapons</span>"}
              [command]
                {VARIABLE hide_ranged_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_ranged_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-ranged.png" "<span color='#60C060'>Show ranged weapons</span>"}
              [command]
                {VARIABLE hide_ranged_$side_number no}
              [/command]
            [/option]
            {SXC_BUY_WEAPON "icons/lightbeam.png" (lightbeam) lightbeam ranged arcane 9 4 "attacks/lightbeam.png" {SOUND_LIST:HOLY} {SOUND_LIST:HOLY_MISS}}
            {SXC_BUY_WEAPON "icons/chakram.png" (chakram) chakram ranged blade 14 5 "attacks/chakram.png" {SOUND_LIST:THROW},dagger-swish.wav {SOUND_LIST:THROW}}
            {SXC_BUY_WEAPON "icons/ice-wave.png" (ice wave) ice_wave ranged cold 14 4 "attacks/dark-missile.png" magic-dark.ogg magic-dark-miss.ogg}
            {SXC_BUY_WEAPON "icons/fireball.png" (fireball) fireball ranged fire 11 4 "attacks/fireball.png" fire.wav fire.wav}
            {SXC_BUY_WEAPON "icons/sling.png" (sling) sling ranged impact 16 4 "attacks/sling.png" sling.ogg sling-miss.ogg}
            {SXC_BUY_WEAPON "icons/crossbow.png" (crossbow) crossbow ranged pierce 13 5 "attacks/crossbow-human.png" crossbow.ogg crossbow-miss.ogg}
            {SXC_SELL_WEAPON 0}
            {SXC_SELL_WEAPON 1}
            {SXC_SELL_WEAPON 2}
            {SXC_SELL_WEAPON 3}
            {SXC_SELL_WEAPON 4}
            {SXC_SELL_WEAPON 5}
            {SXC_SELL_WEAPON 6}
            {SXC_SELL_WEAPON 7}
            {SXC_SELL_WEAPON 8}
            {SXC_SELL_WEAPON 9}
            {SXC_SELL_WEAPON 10}
            {SXC_SELL_WEAPON 11}
          [/message]
          {VARIABLE weapon_i 0}
          [while]
            {SXC_CMP weapon_i less_than $weapon_j}
            [do]
              {CLEAR_VARIABLE sell_text_$weapon_i}
              {CLEAR_VARIABLE price_$weapon_i}
              {CLEAR_VARIABLE name_$weapon_i}
              {CLEAR_VARIABLE specials_count_$weapon_i}
              {CLEAR_VARIABLE specials_list_$weapon_i}
              {CLEAR_VARIABLE specials_price_$weapon_i}
              {CLEAR_VARIABLE specials_array_$weapon_i}
              {VARIABLE_OP weapon_i add 1}
            [/do]
          [/while]
          {CLEAR_VARIABLE name}
          {CLEAR_VARIABLE weapon_i}
          {CLEAR_VARIABLE weapon_j}
          {CLEAR_VARIABLE weapons}
          [redraw]
          [/redraw]
        [/do]
      [/while]
      {CLEAR_VARIABLE weapons_bought}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SXC_SHOP_SPECIALS
  [option]
    message={MENU_IMG_TXT "icons/specials-small.png" "<span color='#A000E0' weight='bold' size='large'>Weapon Specials Shop</span>"}
    [command]
      {VARIABLE finished_sub no}
      [while]
        {SXC_CMP finished_sub equals no}
        [do]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [store_unit]
            [filter]
              side=$side_number
              x,y=$x1,$y1
              canrecruit=yes
            [/filter]
            variable=weapons
          [/store_unit]
          {VARIABLE weapon_j 0}
          {FOREACH weapons.attack weapon_i}
            {VARIABLE name ",$weapons.attack[$weapon_i|].name|,"}
            {VARIABLE name_$weapon_j $weapons.attack[$weapon_i|].name}
            {VARIABLE description_$weapon_j $weapons.attack[$weapon_i|].description}
            {VARIABLE type_$weapon_j $weapons.attack[$weapon_i|].type}
            {VARIABLE range_$weapon_j $weapons.attack[$weapon_i|].range}
            {VARIABLE damage $weapons.attack[$weapon_i|].damage}
            {VARIABLE_OP damage sub $$weapons.attack[$weapon_i|].range|_damage_$side_number}
            {VARIABLE number $weapons.attack[$weapon_i|].number}
            {VARIABLE_OP number sub $$weapons.attack[$weapon_i|].range|_strikes_$side_number}
            {SXC_IDENTIFY_SPECIALS weapons.attack[$weapon_i|].specials $weapon_j|}
            {VARIABLE select_text_$weapon_j "$weapons.attack[$weapon_i|].description|: $weapons.attack[$weapon_i|].range| $weapons.attack[$weapon_i|].type| $damage| - $number|$specials_list_$weapon_j|"}
            {VARIABLE_OP weapon_j add 1}
            {CLEAR_VARIABLE damage}
            {CLEAR_VARIABLE number}
          {NEXT weapon_i}
          [message]
            speaker=narrator
            message="<span color='#40C020' size='x-large' weight='bold'>Weapon Specials</span>
<span weight='bold'>Weapon smith in shop can add or remove specials for any weapon you
have, but he can only add to total number of 2 specials per weapon.
There are allowed only some combinations of specials to buy. Specials,
that your unit got naturally, can only be changed after reaching it's
highest level. Actions in this section can't be canceled.</span>
<span color='#E0E018'>Gold: $gold|</span>
Select weapon you want to add/remove it's special:"
            image="icons/specials.png"
            [option]
              message={MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals no}
                {SXC_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-melee.png" "<span color='#FF9060'>Hide melee weapons</span>"}
              [command]
                {VARIABLE hide_melee_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals yes}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-melee.png" "<span color='#60C060'>Show melee weapons</span>"}
              [command]
                {VARIABLE hide_melee_$side_number no}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_melee_$side_number equals no}
                {SXC_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-ranged.png" "<span color='#FF9060'>Hide ranged weapons</span>"}
              [command]
                {VARIABLE hide_ranged_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP hide_ranged_$side_number equals yes}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-ranged.png" "<span color='#60C060'>Show ranged weapons</span>"}
              [command]
                {VARIABLE hide_ranged_$side_number no}
              [/command]
            [/option]
            {SXC_SHOP_SPECIALS_SET 0}
            {SXC_SHOP_SPECIALS_SET 1}
            {SXC_SHOP_SPECIALS_SET 2}
            {SXC_SHOP_SPECIALS_SET 3}
            {SXC_SHOP_SPECIALS_SET 4}
            {SXC_SHOP_SPECIALS_SET 5}
            {SXC_SHOP_SPECIALS_SET 6}
            {SXC_SHOP_SPECIALS_SET 7}
            {SXC_SHOP_SPECIALS_SET 8}
            {SXC_SHOP_SPECIALS_SET 9}
            {SXC_SHOP_SPECIALS_SET 10}
            {SXC_SHOP_SPECIALS_SET 11}
          [/message]
          {VARIABLE weapon_i 0}
          [while]
            {SXC_CMP weapon_i less_than $weapon_j}
            [do]
              {CLEAR_VARIABLE select_text_$weapon_i}
              {CLEAR_VARIABLE name_$weapon_i}
              {CLEAR_VARIABLE specials_count_$weapon_i}
              {CLEAR_VARIABLE specials_list_$weapon_i}
              {CLEAR_VARIABLE specials_price_$weapon_i}
              {CLEAR_VARIABLE specials_array_$weapon_i}
              {VARIABLE_OP weapon_i add 1}
            [/do]
          [/while]
          {CLEAR_VARIABLE name}
          {CLEAR_VARIABLE weapon_i}
          {CLEAR_VARIABLE weapon_j}
          {CLEAR_VARIABLE weapons}
          [redraw]
          [/redraw]
        [/do]
      [/while]
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SXC_SHOP_ARMORY
  [option]
    [show_if]
      {SXC_CMP maximum_level_reached_$side_number equals "yes"}
    [/show_if]
    message={MENU_IMG_TXT "icons/armory-small.png" "<span color='#00FFFF' weight='bold' size='large'>Armory</span>"}
    [command]
      {VARIABLE finished_sub no}
      {VARIABLE arcane_session 0}
      {VARIABLE blade_session 0}
      {VARIABLE cold_session 0}
      {VARIABLE fire_session 0}
      {VARIABLE impact_session 0}
      {VARIABLE pierce_session 0}
      {VARIABLE arcane_extra 0}
      {VARIABLE blade_extra 0}
      {VARIABLE cold_extra 0}
      {VARIABLE fire_extra 0}
      {VARIABLE impact_extra 0}
      {VARIABLE pierce_extra 0}
      [while]
        {SXC_CMP finished_sub equals no}
        [do]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [store_unit]
            [filter]
              side=$side_number
              x,y=$x1,$y1
              canrecruit=yes
            [/filter]
            variable=armory
          [/store_unit]
          {VARIABLE current_arcane 100}
          {VARIABLE current_blade 100}
          {VARIABLE current_cold 100}
          {VARIABLE current_fire 100}
          {VARIABLE current_impact 100}
          {VARIABLE current_pierce 100}
          {VARIABLE_OP current_arcane sub $arcane_boost_$side_number}
          {VARIABLE_OP current_blade sub $blade_boost_$side_number}
          {VARIABLE_OP current_cold sub $cold_boost_$side_number}
          {VARIABLE_OP current_fire sub $fire_boost_$side_number}
          {VARIABLE_OP current_impact sub $impact_boost_$side_number}
          {VARIABLE_OP current_pierce sub $pierce_boost_$side_number}
          {VARIABLE_OP current_arcane sub $armory.resistance.arcane}
          {VARIABLE_OP current_blade sub $armory.resistance.blade}
          {VARIABLE_OP current_cold sub $armory.resistance.cold}
          {VARIABLE_OP current_fire sub $armory.resistance.fire}
          {VARIABLE_OP current_impact sub $armory.resistance.impact}
          {VARIABLE_OP current_pierce sub $armory.resistance.pierce}
          {VARIABLE left $armor_total_$side_number}
          {VARIABLE_OP left sub $extra_armor_bought_$side_number}
          {VARIABLE extra $extra_armor_bought_$side_number}
          [message]
            speaker=narrator
            message="<span color='#40C020' size='x-large' weight='bold'>Armory</span>
<span color='#FF2020' weight='bold'>The EXTRA armor upgrades shown are all you can get,
choose carefully, which resistances you need!</span>
<span weight='bold'>Extra resistances for your level are all resistances
over $armor_limit_$side_number||%, that you will buy.</span>
<span color='#E0E018'>Gold: $gold|</span>
<span color='#40FF40'>EXTRA upgrades left: $left|%</span>
<span color='#10C8F8' weight='bold'>Current resistances:</span>
<span color='#10C8F8' face='dejavu sans mono,monospace' size='small'>Blade:  $current_blade|%      Arcane: $current_arcane|%
Impact: $current_impact|%      Cold:   $current_cold|%
Pierce: $current_pierce|%      Fire:   $current_fire|%</span>"
            image="icons/armory.png"
            [option]
              message={MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub yes}
              [/command]
            [/option]
            {SXC_ARMORY_TYPE blade}
            {SXC_ARMORY_TYPE impact}
            {SXC_ARMORY_TYPE pierce}
            {SXC_ARMORY_TYPE arcane}
            {SXC_ARMORY_TYPE cold}
            {SXC_ARMORY_TYPE fire}
          [/message]
          {CLEAR_VARIABLE current_arcane}
          {CLEAR_VARIABLE current_blade}
          {CLEAR_VARIABLE current_cold}
          {CLEAR_VARIABLE current_fire}
          {CLEAR_VARIABLE current_impact}
          {CLEAR_VARIABLE current_pierce}
          {CLEAR_VARIABLE left}
          {CLEAR_VARIABLE extra}
          {CLEAR_VARIABLE armory}
          {CLEAR_VARIABLE armory_warning}
          [redraw]
          [/redraw]
        [/do]
      [/while]
      {CLEAR_VARIABLE arcane_session}
      {CLEAR_VARIABLE blade_session}
      {CLEAR_VARIABLE cold_session}
      {CLEAR_VARIABLE fire_session}
      {CLEAR_VARIABLE impact_session}
      {CLEAR_VARIABLE pierce_session}
      {CLEAR_VARIABLE arcane_extra}
      {CLEAR_VARIABLE blade_extra}
      {CLEAR_VARIABLE cold_extra}
      {CLEAR_VARIABLE fire_extra}
      {CLEAR_VARIABLE impact_extra}
      {CLEAR_VARIABLE pierce_extra}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SXC_SHOP_MOVEMENTS
  [option]
    message={MENU_IMG_TXT "icons/terrain-training-small.png" "<span color='#E0C020' weight='bold' size='large'>Terrain Training</span>"}
    [command]
      {VARIABLE finished_sub no}
      [while]
        {SXC_CMP finished_sub equals no}
        [do]
          [store_unit]
            [filter]
              side=$side_number
              x,y=$x1,$y1
              canrecruit=yes
            [/filter]
            variable=movements
          [/store_unit]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          {VARIABLE left $terrains_left_$side_number}
          {SXC_TRAINING_CHECK mc_castle}
          {SXC_TRAINING_CHECK mc_cave}
          {SXC_TRAINING_CHECK mc_deep_water}
          {SXC_TRAINING_CHECK mc_flat}
          {SXC_TRAINING_CHECK mc_forest}
          {SXC_TRAINING_CHECK mc_frozen}
          {SXC_TRAINING_CHECK mc_fungus}
          {SXC_TRAINING_CHECK mc_hills}
          {SXC_TRAINING_CHECK mc_impassable}
          {SXC_TRAINING_CHECK mc_mountains}
          {SXC_TRAINING_CHECK mc_reef}
          {SXC_TRAINING_CHECK mc_sand}
          {SXC_TRAINING_CHECK mc_shallow_water}
          {SXC_TRAINING_CHECK mc_swamp_water}
          {SXC_TRAINING_CHECK mc_unwalkable}
          {SXC_TRAINING_CHECK mc_village}
          {VARIABLE mc_price $left}
          {VARIABLE_OP mc_price add 1}
          {VARIABLE mc_price_old 5.0}
          {SXC_ROUND mc_price_old divide $mc_price ceil}
          {VARIABLE_OP mc_price_old multiply 5}
          [if]
            {SXC_CMP left numerical_not_equals 0}
            [then]
              {VARIABLE mc_price 5.0}
              {SXC_ROUND mc_price divide $left ceil}
              {VARIABLE_OP mc_price multiply 5}
            [/then]
            [else]
              {VARIABLE mc_price 25}
            [/else]
          [/if]
          [message]
            speaker=narrator
            message="<span color='#40C020' size='x-large' weight='bold'>Terrain training</span>
<span weight='bold'>Here you can decrease movement cost for selected
terrain, but the trainings number is limited.</span>
<span color='#E0E018'>Gold: $gold|</span>
<span color='#40FF40'>Training left: $left|</span>
<span color='#10C8F8' weight='bold'>Current movement costs:</span>
<span color='#10C8F8' face='dejavu sans mono,monospace' size='x-small'>
Castle:        $movements.movement_costs.castle| $mc_castle| Cave:          $movements.movement_costs.cave| $mc_cave| Deep water:    $movements.movement_costs.deep_water| $mc_deep_water| Flat:          $movements.movement_costs.flat| $mc_flat|
Forest:        $movements.movement_costs.forest| $mc_forest| Frozen:        $movements.movement_costs.frozen| $mc_frozen| Fungus:        $movements.movement_costs.fungus| $mc_fungus| Hills:         $movements.movement_costs.hills| $mc_hills|
Mountains:     $movements.movement_costs.mountains| $mc_mountains| Reef:          $movements.movement_costs.reef| $mc_reef| Sand:          $movements.movement_costs.sand| $mc_sand| Shallow water: $movements.movement_costs.shallow_water| $mc_shallow_water|
Swamp water:   $movements.movement_costs.swamp_water| $mc_swamp_water| Village:       $movements.movement_costs.village| $mc_village| Unwalkable:    $movements.movement_costs.unwalkable| $mc_unwalkable| Impassable:    $movements.movement_costs.impassable| $mc_impassable|</span>"
            image="icons/terrain-training.png"
            [option]
              message={MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.castle greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/castle-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for castle (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_castle_$side_number "1"}
                    {VARIABLE mc_castle_session $movements.movement_costs.castle}
                    {VARIABLE movements.movement_costs.castle 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_castle_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/castle-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for castle</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_castle_$side_number 0}
                {VARIABLE movements.movement_costs.castle $mc_castle_session}
                {CLEAR_VARIABLE mc_castle_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.cave greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/cave-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for cave (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_cave_$side_number 1}
                    {VARIABLE mc_cave_session $movements.movement_costs.cave}
                    {VARIABLE movements.movement_costs.cave 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_cave_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/cave-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for cave</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_cave_$side_number 0}
                {VARIABLE movements.movement_costs.cave $mc_cave_session}
                {CLEAR_VARIABLE mc_cave_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP left greater_than 0}
                {SXC_CMP movements.flying boolean_equals yes}
                {SXC_CMP movements.movement_costs.deep_water greater_than 1}
              [/show_if]
              message={MENU_IMG_TXT "icons/deep-water-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for deep water (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_deep_water_$side_number 1}
                    {VARIABLE mc_deep_water_session $movements.movement_costs.deep_water}
                    {VARIABLE movements.movement_costs.deep_water 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.deep_water greater_than 3}
                {SXC_CMP movements.flying boolean_equals no}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/deep-water-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for deep water (to 3MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_deep_water_$side_number 1}
                    {VARIABLE mc_deep_water_session $movements.movement_costs.deep_water}
                    {VARIABLE movements.movement_costs.deep_water 3}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_deep_water_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/deep-water-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for deep water</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_deep_water_$side_number 0}
                {VARIABLE movements.movement_costs.deep_water $mc_deep_water_session}
                {CLEAR_VARIABLE mc_deep_water_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.flat greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/flat-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for flat (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_flat_$side_number 1}
                    {VARIABLE mc_flat_session $movements.movement_costs.flat}
                    {VARIABLE movements.movement_costs.flat 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_flat_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/flat-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for flat</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_flat_$side_number 0}
                {VARIABLE movements.movement_costs.flat $mc_flat_session}
                {CLEAR_VARIABLE mc_flat_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.forest greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/forest-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for forest (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_forest_$side_number 1}
                    {VARIABLE mc_forest_session $movements.movement_costs.forest}
                    {VARIABLE movements.movement_costs.forest 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_forest_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/forest-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for forest</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_forest_$side_number 0}
                {VARIABLE movements.movement_costs.forest $mc_forest_session}
                {CLEAR_VARIABLE mc_forest_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.frozen greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/frozen-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for frozen (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_frozen_$side_number 1}
                    {VARIABLE mc_frozen_session $movements.movement_costs.frozen}
                    {VARIABLE movements.movement_costs.frozen 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_frozen_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/frozen-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for frozen</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_frozen_$side_number 0}
                {VARIABLE movements.movement_costs.frozen $mc_frozen_session}
                {CLEAR_VARIABLE mc_frozen_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.fungus greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/fungus-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for fungus (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_fungus_$side_number 1}
                    {VARIABLE mc_fungus_session $movements.movement_costs.fungus}
                    {VARIABLE movements.movement_costs.fungus 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_fungus_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/fungus-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for fungus</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_fungus_$side_number 0}
                {VARIABLE movements.movement_costs.fungus $mc_fungus_session}
                {CLEAR_VARIABLE mc_fungus_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.hills greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/hills-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for hills (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_hills_$side_number 1}
                    {VARIABLE mc_hills_session $movements.movement_costs.hills}
                    {VARIABLE movements.movement_costs.hills 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_hills_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/hills-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for hills</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_hills_$side_number 0}
                {VARIABLE movements.movement_costs.hills $mc_hills_session}
                {CLEAR_VARIABLE mc_hills_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.mountains greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/mountains-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for mountains (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_mountains_$side_number 1}
                    {VARIABLE mc_mountains_session $movements.movement_costs.mountains}
                    {VARIABLE movements.movement_costs.mountains 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_mountains_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/mountains-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for mountains</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_mountains_$side_number 0}
                {VARIABLE movements.movement_costs.mountains $mc_mountains_session}
                {CLEAR_VARIABLE mc_mountains_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.reef greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/reef-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for reef (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_reef_$side_number 1}
                    {VARIABLE mc_reef_session $movements.movement_costs.reef}
                    {VARIABLE movements.movement_costs.reef 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_reef_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/reef-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for reef</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_reef_$side_number 0}
                {VARIABLE movements.movement_costs.reef $mc_reef_session}
                {CLEAR_VARIABLE mc_reef_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.sand greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/sand-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for sand (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_sand_$side_number 1}
                    {VARIABLE mc_sand_session $movements.movement_costs.sand}
                    {VARIABLE movements.movement_costs.sand 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_sand_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/sand-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for sand</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_sand_$side_number 0}
                {VARIABLE movements.movement_costs.sand $mc_sand_session}
                {CLEAR_VARIABLE mc_sand_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.shallow_water greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/shallow-water-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for shallow water (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_shallow_water_$side_number 1}
                    {VARIABLE mc_shallow_water_session $movements.movement_costs.shallow_water}
                    {VARIABLE movements.movement_costs.shallow_water 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_shallow_water_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/shallow-water-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for shallow water</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_shallow_water_$side_number 0}
                {VARIABLE movements.movement_costs.shallow_water $mc_shallow_water_session}
                {CLEAR_VARIABLE mc_shallow_water_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.swamp_water greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/swamp-water-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for swamp water (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_swamp_water_$side_number 1}
                    {VARIABLE mc_swamp_water_session $movements.movement_costs.swamp_water}
                    {VARIABLE movements.movement_costs.swamp_water 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_swamp_water_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/swamp-water-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for swamp_water</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_swamp_water_$side_number 0}
                {VARIABLE movements.movement_costs.swamp_water $mc_swamp_water_session}
                {CLEAR_VARIABLE mc_swamp_water_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP movements.movement_costs.village greater_than 1}
                {SXC_CMP left greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/village-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for village (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_village_$side_number 1}
                    {VARIABLE mc_village_session $movements.movement_costs.village}
                    {VARIABLE movements.movement_costs.village 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_village_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/village-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for village</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_village_$side_number 0}
                {VARIABLE movements.movement_costs.village $mc_village_session}
                {CLEAR_VARIABLE mc_village_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP left greater_than 0}
                {SXC_CMP movements.flying boolean_equals yes}
                {SXC_CMP movements.movement_costs.unwalkable greater_than 1}
              [/show_if]
              message={MENU_IMG_TXT "icons/unwalkable-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for unwalkable (to 1MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_unwalkable_$side_number 1}
                    {VARIABLE mc_unwalkable_session $movements.movement_costs.unwalkable}
                    {VARIABLE movements.movement_costs.unwalkable 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP left greater_than 0}
                {SXC_CMP movements.flying boolean_equals no}
                {SXC_CMP movements.movement_costs.unwalkable greater_than 3}
              [/show_if]
              message={MENU_IMG_TXT "icons/unwalkable-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for unwalkable (to 3MP cost)</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_unwalkable_$side_number 1}
                    {VARIABLE mc_unwalkable_session $movements.movement_costs.unwalkable}
                    {VARIABLE movements.movement_costs.unwalkable 3}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP mc_unwalkable_session greater_than 0}
              [/show_if]
              message={MENU_IMG_TXT "icons/unwalkable-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for unwalkable</span>"}
              [command]
                [gold]
                  amount=$mc_price_old
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_unwalkable_$side_number 0}
                {VARIABLE movements.movement_costs.unwalkable $mc_unwalkable_session}
                {CLEAR_VARIABLE mc_unwalkable_session}
              [/command]
            [/option]
#             [option]
#               [show_if]
#                 {SXC_CMP left greater_than 0}
#                 {SXC_CMP movements.flying boolean_equals yes}
#                 {SXC_CMP movements.movement_costs.impassable greater_than 1}
#               [/show_if]
#               message={MENU_IMG_TXT "icons/impassable-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for impassable (to 1MP cost)</span>"}
#               [command]
#                 [if]
#                   {SXC_CMP gold greater_than_equal_to $mc_price}
#                   [then]
#                     [gold]
#                       amount=-$mc_price
#                       side=$side_number
#                     [/gold]
#                     {VARIABLE_OP terrains_left_$side_number add -1}
#                     {VARIABLE mc_impassable_$side_number 1}
#                     {VARIABLE mc_impassable_session $movements.movement_costs.impassable}
#                     {VARIABLE movements.movement_costs.impassable 1}
#                   [/then]
#                 [/if]
#               [/command]
#             [/option]
#             [option]
#               [show_if]
#                 {SXC_CMP left greater_than 0}
#                 {SXC_CMP movements.flying boolean_equals no}
#                 {SXC_CMP movements.movement_costs.impassable greater_than 2}
#               [/show_if]
#               message={MENU_IMG_TXT "icons/impassable-buy.png" "<span color='#80FF80'>$mc_price| gold: Buy training for impassable (to 2MP cost)</span>"}
#               [command]
#                 [if]
#                   {SXC_CMP gold greater_than_equal_to $mc_price}
#                   [then]
#                     [gold]
#                       amount=-$mc_price
#                       side=$side_number
#                     [/gold]
#                     {VARIABLE_OP terrains_left_$side_number add -1}
#                     {VARIABLE mc_impassable_$side_number 1}
#                     {VARIABLE mc_impassable_session $movements.movement_costs.impassable}
#                     {VARIABLE movements.movement_costs.impassable 2}
#                   [/then]
#                 [/if]
#               [/command]
#             [/option]
#             [option]
#               [show_if]
#                 {SXC_CMP mc_impassable_session greater_than 0}
#               [/show_if]
#               message={MENU_IMG_TXT "icons/impassable-cancel.png" "<span color='#FF8080'>+$mc_price_old| gold: Cancel training for impassable</span>"}
#               [command]
#                 [gold]
#                   amount=$mc_price_old
#                   side=$side_number
#                 [/gold]
#                 {VARIABLE_OP terrains_left_$side_number add 1}
#                 {VARIABLE mc_impassable_$side_number 0}
#                 {VARIABLE movements.movement_costs.impassable $mc_impassable_session}
#                 {CLEAR_VARIABLE mc_impassable_session}
#               [/command]
#             [/option]
          [/message]
          [unstore_unit]
            variable=movements
          [/unstore_unit]
          {CLEAR_VARIABLE left}
          {CLEAR_VARIABLE mc_castle}
          {CLEAR_VARIABLE mc_cave}
          {CLEAR_VARIABLE mc_deep_water}
          {CLEAR_VARIABLE mc_flat}
          {CLEAR_VARIABLE mc_forest}
          {CLEAR_VARIABLE mc_frozen}
          {CLEAR_VARIABLE mc_fungus}
          {CLEAR_VARIABLE mc_hills}
          {CLEAR_VARIABLE mc_impassable}
          {CLEAR_VARIABLE mc_mountains}
          {CLEAR_VARIABLE mc_reef}
          {CLEAR_VARIABLE mc_sand}
          {CLEAR_VARIABLE mc_shallow_water}
          {CLEAR_VARIABLE mc_swamp_water}
          {CLEAR_VARIABLE mc_unwalkable}
          {CLEAR_VARIABLE mc_village}
          [redraw]
          [/redraw]
        [/do]
      [/while]
      {CLEAR_VARIABLE mc_castle_session}
      {CLEAR_VARIABLE mc_cave_session}
      {CLEAR_VARIABLE mc_deep_water_session}
      {CLEAR_VARIABLE mc_flat_session}
      {CLEAR_VARIABLE mc_forest_session}
      {CLEAR_VARIABLE mc_frozen_session}
      {CLEAR_VARIABLE mc_fungus_session}
      {CLEAR_VARIABLE mc_hills_session}
      {CLEAR_VARIABLE mc_impassable_session}
      {CLEAR_VARIABLE mc_mountains_session}
      {CLEAR_VARIABLE mc_reef_session}
      {CLEAR_VARIABLE mc_sand_session}
      {CLEAR_VARIABLE mc_shallow_water_session}
      {CLEAR_VARIABLE mc_swamp_water_session}
      {CLEAR_VARIABLE mc_unwalkable_session}
      {CLEAR_VARIABLE mc_village_session}
      {CLEAR_VARIABLE mc_price}
      {CLEAR_VARIABLE mc_price_old}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SXC_SHOP_ABILITIES
  [option]
    [show_if]
      {SXC_CMP maximum_level_reached_$side_number equals "yes"}
    [/show_if]
    message={MENU_IMG_TXT "icons/abilities-small.png" "<span color='#A0FF70' weight='bold' size='large'>Abilities Shop</span>"}
    [command]
      {VARIABLE finished_sub no}
      [while]
        {SXC_CMP finished_sub equals no}
        [do]
          [store_unit]
            [filter]
              side=$side_number
              canrecruit=yes
              x,y=$x1,$y1
              ability=sxc_dauntless
            [/filter]
            variable=leader_abilities
          [/store_unit]
          {VARIABLE sxc_has_dauntless $leader_abilities.length}
          {CLEAR_VARIABLE leader_abilities}
          [store_unit]
            [filter]
              side=$side_number
              canrecruit=yes
              x,y=$x1,$y1
              [and]
                [filter_wml]
                  [trait]
                    id=fearless
                  [/trait]
                [/filter_wml]
                [or]
                  [filter_wml]
                    [modifications]
                      [trait]
                        id=fearless
                      [/trait]
                    [/modifications]
                  [/filter_wml]
                [/or]
              [/and]
            [/filter]
            variable=leader_abilities
          [/store_unit]
          {VARIABLE sxc_has_fearless $leader_abilities.length}
          {CLEAR_VARIABLE leader_abilities}
          [store_unit]
            [filter]
              side=$side_number
              canrecruit=yes
              x,y=$x1,$y1
              ability=sxc_leadership
            [/filter]
            variable=leader_abilities
          [/store_unit]
          {VARIABLE sxc_has_leadership $leader_abilities.length}
          {CLEAR_VARIABLE leader_abilities}
          [store_unit]
            [filter]
              side=$side_number
              canrecruit=yes
              x,y=$x1,$y1
              ability=sxc_megacures
            [/filter]
            variable=leader_abilities
          [/store_unit]
          {VARIABLE sxc_has_megacures $leader_abilities.length}
          {CLEAR_VARIABLE leader_abilities}
          [store_unit]
            [filter]
              side=$side_number
              canrecruit=yes
              x,y=$x1,$y1
              ability=sxc_megaregenerates
            [/filter]
            variable=leader_abilities
          [/store_unit]
          {VARIABLE sxc_has_megaregenerates $leader_abilities.length}
          {CLEAR_VARIABLE leader_abilities}
          [store_unit]
            [filter]
              side=$side_number
              canrecruit=yes
              x,y=$x1,$y1
              ability=sxc_minorcures
            [/filter]
            variable=leader_abilities
          [/store_unit]
          {VARIABLE sxc_has_minorcures $leader_abilities.length}
          {CLEAR_VARIABLE leader_abilities}
          [store_unit]
            [filter]
              side=$side_number
              canrecruit=yes
              x,y=$x1,$y1
              ability=skirmisher
            [/filter]
            variable=leader_abilities
          [/store_unit]
          {VARIABLE sxc_has_skirmisher $leader_abilities.length}
          {CLEAR_VARIABLE leader_abilities}
          [store_unit]
            [filter]
              side=$side_number
              canrecruit=yes
              x,y=$x1,$y1
              ability=sxc_soulstealer
            [/filter]
            variable=leader_abilities
          [/store_unit]
          {VARIABLE sxc_has_soulstealer $leader_abilities.length}
          {CLEAR_VARIABLE leader_abilities}
          [store_unit]
            [filter]
              side=$side_number
              canrecruit=yes
              x,y=$x1,$y1
              ability=sxc_speedy
            [/filter]
            variable=leader_abilities
          [/store_unit]
          {VARIABLE sxc_has_speedy $leader_abilities.length}
          {CLEAR_VARIABLE leader_abilities}
          [store_unit]
            [filter]
              side=$side_number
              canrecruit=yes
              x,y=$x1,$y1
              ability=sxc_steadfast
            [/filter]
            variable=leader_abilities
          [/store_unit]
          {VARIABLE sxc_has_steadfast $leader_abilities.length}
          {CLEAR_VARIABLE leader_abilities}
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          {VARIABLE abilities_left 2}
          {VARIABLE_OP abilities_left sub $abilities_$side_number}
          [message]
            speaker=narrator
            message="<span color='#40C020' size='x-large' weight='bold'>Abilities</span>
<span weight='bold'>Abilities gained in this shop can't be removed. Choose carefully
which abilities you want to buy to get best combination of them.
You can only buy 2 abilities, other can be gained from magical
items, which can be found across the map or dropped by killed
bosses (these are not calculated into upgrades from shop).</span>
<span color='#E0E018'>Gold: $gold|</span>
Select ability you want to buy (<span color='#40FF40'>$abilities_left| upgrades left</span>):"
            image="icons/abilities.png"
            [option]
              message={MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_has_dauntless numerical_equals 0}
                {SXC_CMP abilities_left greater_than 0}
                {SXC_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/dauntless.png" "<span color='#80FF80'>200 gold: learn ability Dauntless</span>
<span size='small'>Doubles resistance up to 50% on offense. Negative
resistances and resistances over 50% are not affected.</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 200}
                  [then]
                    [gold]
                      amount=-200
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          {ABILITY_SXC_DAUNTLESS}
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_has_fearless numerical_equals 0}
                {SXC_CMP abilities_left greater_than 0}
                {SXC_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/fearless.png" "<span color='#80FF80'>100 gold: gain trait Fearless</span>
<span size='small'>Unit fights normally during unfavorable times of day/night.</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 100}
                  [then]
                    [gold]
                      amount=-100
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to="fearless"
                      [/effect]
                    [/object]
                    [store_unit]
                      [filter]
                        side=$side_number
                        x,y=$x1,$y1
                        canrecruit=yes
                      [/filter]
                      variable=trait_fearless
                    [/store_unit]
                    {VARIABLE new_trait $trait_fearless.modifications.trait.length}
                    {VARIABLE trait_fearless.modifications.trait[$new_trait|].id ("fearless")}
                    {VARIABLE trait_fearless.modifications.trait[$new_trait|].male_name (_ "fearless")}
                    {VARIABLE trait_fearless.modifications.trait[$new_trait|].female_name (_ "female^fearless")}
                    {VARIABLE trait_fearless.modifications.trait[$new_trait|].description (_ "Fights normally during unfavorable times of day/night")}
                    [unstore_unit]
                      variable=trait_fearless
                    [/unstore_unit]
                    {VARIABLE_OP abilities_$side_number add 1}
                    {CLEAR_VARIABLE trait_fearless}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_has_leadership numerical_equals 0}
                {SXC_CMP abilities_left greater_than 0}
                {SXC_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/damage-both.png" "<span color='#80FF80'>200 gold: learn ability Leadership level 5</span>
<span size='small'>Unit will lead alied units with lower level than 5, so they
cause (5 - their_level) * 20% more damage while adjacent to it.
It also affects unit that gain this ability so it is stronger.
This will replace all normal leadership abilities.</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 200}
                  [then]
                    [gold]
                      amount=-200
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          {ABILITY_SXC_LEADERSHIP}
                          [/abilities]
                        [/effect]
                      [/object]
                      {VARIABLE_OP abilities_$side_number add 1}
                    [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_has_megacures numerical_equals 0}
                {SXC_CMP sxc_has_minorcures numerical_equals 0}
                {SXC_CMP abilities_left greater_than 0}
                {SXC_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/megacures.png" "<span color='#80FF80'>125 gold: learn ability Megacures</span>
<span size='small'>Unit heals adjacent friendly units 20% of own maximum health
per turn or cures them from poison if they are poisoned.
This will replace all normal healing abilities.</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 125}
                  [then]
                    [gold]
                      amount=-125
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          {ABILITY_SXC_MEGACURES}
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_has_minorcures numerical_not_equals 0}
                {SXC_CMP abilities_left greater_than 0}
                {SXC_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/megacures.png" "<span color='#80FF80'>75 gold: learn ability Megacures</span>
<span size='small'>Unit heals adjacent friendly units 16% of own maximum health
per turn or cures them from poison if they are poisoned.
This will replace all normal healing abilities.</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 75}
                  [then]
                    [gold]
                      amount=-75
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=remove_ability
                        [abilities]
                          [heals]
                            id=sxc_minorcures
                          [/heals]
                        [/abilities]
                      [/effect]
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          {ABILITY_SXC_MEGACURES}
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_has_megaregenerates numerical_equals 0}
                {SXC_CMP abilities_left greater_than 0}
                {SXC_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/megaregenerates.png" "<span color='#80FF80'>200 gold: learn ability Megaregenerates</span>
<span size='small'>Unit heals itself 16% of maximum health per turn
or cures itself from poison if unit is poisoned.
This will replace all normal regenerate abilities.</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 200}
                  [then]
                    [gold]
                      amount=-200
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          {ABILITY_SXC_MEGAREGENERATES}
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_has_skirmisher numerical_equals 0}
                {SXC_CMP abilities_left greater_than 0}
                {SXC_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/skirmisher.png" "<span color='#80FF80'>125 gold: learn ability Skirmisher</span>
<span size='small'>Unit ignores all enemy zones of control.</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 125}
                  [then]
                    [gold]
                      amount=-125
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          {ABILITY_SKIRMISHER}
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_has_soulstealer numerical_equals 0}
                {SXC_CMP abilities_left greater_than 0}
                {SXC_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/soulstealer.png" "<span color='#80FF80'>100 gold: learn ability Soulstealer</span>
<span size='small'>Unit gains +1 max. every time it kills enemy unit,
regardless whether it is living or not.
This will replace all normal feeding abilities.</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 100}
                  [then]
                    [gold]
                      amount=-100
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          {ABILITY_SXC_SOULSTEALER}
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_has_speedy numerical_equals 0}
                {SXC_CMP abilities_left greater_than 0}
                {SXC_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/speedy.png" "<span color='#80FF80'>150 gold: learn ability Speedy</span>
<span size='small'>Unit has +2 movement points at start of each turn and
also +1 movement point every time it kills enemy unit.</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 150}
                  [then]
                    [gold]
                      amount=-150
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          {ABILITY_SXC_SPEEDY}
                        [/abilities]
                      [/effect]
                      [effect]
                        apply_to=movement
                        increase=2
                      [/effect]
                    [/object]
                    {VARIABLE speedy_$side_number 2}
                    {VARIABLE_OP mp_kill_$side_number add 1}
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SXC_CMP sxc_has_steadfast numerical_equals 0}
                {SXC_CMP abilities_left greater_than 0}
                {SXC_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message={MENU_IMG_TXT "icons/steadfast.png" "<span color='#80FF80'>200 gold: learn ability Steadfast</span>
<span size='small'>Doubles resistance up to 50% on defense. Negative
resistances and resistances over 50% are not affected.</span>"}
              [command]
                [if]
                  {SXC_CMP gold greater_than_equal_to 200}
                  [then]
                    [gold]
                      amount=-200
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          {ABILITY_SXC_STEADFAST}
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
          [/message]
          [redraw]
          [/redraw]
          {CLEAR_VARIABLE sxc_has_dauntless}
          {CLEAR_VARIABLE sxc_has_fearless}
          {CLEAR_VARIABLE sxc_has_leadership}
          {CLEAR_VARIABLE sxc_has_megacures}
          {CLEAR_VARIABLE sxc_has_megaregenerates}
          {CLEAR_VARIABLE sxc_has_minorcures}
          {CLEAR_VARIABLE sxc_has_skirmisher}
          {CLEAR_VARIABLE sxc_has_soulstealer}
          {CLEAR_VARIABLE sxc_has_speedy}
          {CLEAR_VARIABLE sxc_has_steadfast}
        [/do]
      [/while]
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SXC_SHOP_ITEMS
  [option]
    [show_if]
      {SXC_CMP allow_shop_potions equals "yes"}
    [/show_if]
    message={MENU_IMG_TXT "icons/potions+items-small.png" "<span color='#FFA020' weight='bold' size='large'>Potions &amp; items</span>"}
    [command]
      {VARIABLE finished_sub no}
      {VARIABLE black_potions 0}
      {VARIABLE blue_potions 0}
      {VARIABLE brown_potions 0}
      {VARIABLE cyan_potions 0}
      {VARIABLE grey_potions 0}
      {VARIABLE green_potions 0}
      {VARIABLE orange_potions 0}
      {VARIABLE pink_potions 0}
      {VARIABLE red_potions 0}
      {VARIABLE violet_potions 0}
      {VARIABLE white_potions 0}
      {VARIABLE yellow_potions 0}
      [while]
        {SXC_CMP finished_sub equals no}
        [do]
          {VARIABLE potions_list ""}
          [if]
            {SXC_CMP allow_shop_blackp equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Black potions: $black_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_bluep equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Blue potions: $blue_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_brownp equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Brown potions: $brown_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_cyanp equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Cyan potions: $cyan_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_greyp equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Grey potions: $grey_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_greenp equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Green potions: $green_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_orangep equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Orange potions: $orange_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_pinkp equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Pink potions: $pink_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_redp equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Red potions: $red_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_violetp equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Violet potions: $violet_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_whitep equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
White potions: $white_potions_$side_number|| (max.1) "}
            [/then]
          [/if]
          [if]
            {SXC_CMP allow_shop_yellowp equals "yes"}
            [then]
              {VARIABLE potions_list "$potions_list|
Yellow potions: $yellow_potions_$side_number|| (max 1) "}
            [/then]
          [/if]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [message]
            speaker=narrator
            message="<span color='#40C020' size='x-large' weight='bold'>Potions &amp; items</span>
<span weight='bold'>Here you can buy various useful potions or items. To use potions,
right-click on your unit and select potion from menu (inventory).</span>
<span color='#E0E018'>Gold: $gold|</span><span color='#40FF40'>$potions_list|</span>
<span color='#10C8F8' weight='bold'>Total number of potions: $potions_total_$side_number|| of max. 4</span>"
            image="icons/potions+items.png"
            [option]
              message={MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub yes}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-black-sell.png" "<span color='#FF4040'>+100 gold: sell black potion</span>"}
              [show_if]
                {SXC_CMP black_potions_$side_number numerical_not_equals 0}
                {SXC_CMP black_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_blackp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=100
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP black_potions_$side_number add -1}
                {VARIABLE_OP black_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-black-sell.png" "<span color='#FF4040'>+80 gold: sell black potion</span>"}
              [show_if]
                {SXC_CMP black_potions_$side_number numerical_not_equals 0}
                {SXC_CMP black_potions numerical_equals 0}
                {SXC_CMP allow_shop_blackp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=80
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP black_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-black-buy.png" "<span color='#40FF40'>100 gold: buy black potion (2x damage for 1 turn)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP black_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_blackp equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 100}
                  [then]
                    [gold]
                      amount=-100
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP black_potions_$side_number add 1}
                    {VARIABLE_OP black_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-blue-sell.png" "<span color='#FF4040'>+100 gold: sell blue potion</span>"}
              [show_if]
                {SXC_CMP blue_potions_$side_number numerical_not_equals 0}
                {SXC_CMP blue_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_bluep equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=100
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP blue_potions_$side_number add -1}
                {VARIABLE_OP blue_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-blue-sell.png" "<span color='#FF4040'>+80 gold: sell blue potion</span>"}
              [show_if]
                {SXC_CMP blue_potions_$side_number numerical_not_equals 0}
                {SXC_CMP blue_potions numerical_equals 0}
                {SXC_CMP allow_shop_bluep equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=80
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP blue_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-blue-buy.png" "<span color='#40FF40'>100 gold: buy blue potion (+5MP, extra attack, +150HP)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP blue_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_bluep equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 100}
                  [then]
                    [gold]
                      amount=-100
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP blue_potions_$side_number add 1}
                    {VARIABLE_OP blue_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-brown-sell.png" "<span color='#FF4040'>+100 gold: sell brown potion</span>"}
              [show_if]
                {SXC_CMP brown_potions_$side_number numerical_not_equals 0}
                {SXC_CMP brown_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_brownp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=100
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP brown_potions_$side_number add -1}
                {VARIABLE_OP brown_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-brown-sell.png" "<span color='#FF4040'>+80 gold: sell brown potion</span>"}
              [show_if]
                {SXC_CMP brown_potions_$side_number numerical_not_equals 0}
                {SXC_CMP brown_potions numerical_equals 0}
                {SXC_CMP allow_shop_brownp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=80
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP brown_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-brown-buy.png" "<span color='#40FF40'>100 gold: buy brown potion (+10% resistances for 1 turn)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP brown_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_brownp equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 100}
                  [then]
                    [gold]
                      amount=-100
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP brown_potions_$side_number add 1}
                    {VARIABLE_OP brown_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-cyan-sell.png" "<span color='#FF4040'>+40 gold: sell cyan potion</span>"}
              [show_if]
                {SXC_CMP cyan_potions_$side_number numerical_not_equals 0}
                {SXC_CMP cyan_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_cyanp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=40
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP cyan_potions_$side_number add -1}
                {VARIABLE_OP cyan_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-cyan-sell.png" "<span color='#FF4040'>+32 gold: sell cyan potion</span>"}
              [show_if]
                {SXC_CMP cyan_potions_$side_number numerical_not_equals 0}
                {SXC_CMP cyan_potions numerical_equals 0}
                {SXC_CMP allow_shop_cyanp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=32
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP cyan_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-cyan-buy.png" "<span color='#40FF40'>40 gold: buy cyan potion (+9MP, unslow)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP cyan_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_cyanp equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 40}
                  [then]
                    [gold]
                      amount=-40
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP cyan_potions_$side_number add 1}
                    {VARIABLE_OP cyan_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-grey-sell.png" "<span color='#FF4040'>+0 gold: sell grey potion</span>"}
              [show_if]
                {SXC_CMP grey_potions_$side_number numerical_not_equals 0}
                {SXC_CMP grey_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_greyp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP grey_potions_$side_number add -1}
                {VARIABLE_OP grey_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-grey-sell.png" "<span color='#FF4040'>+0 gold: sell grey potion</span>"}
              [show_if]
                {SXC_CMP grey_potions_$side_number numerical_not_equals 0}
                {SXC_CMP grey_potions numerical_equals 0}
                {SXC_CMP allow_shop_greyp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP grey_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-grey-buy.png" "<span color='#40FF40'>0 gold: buy grey potion (not defined yet)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP grey_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_greyp equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 0}
                  [then]
                    [gold]
                      amount=-0
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP grey_potions_$side_number add 1}
                    {VARIABLE_OP grey_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-green-sell.png" "<span color='#FF4040'>+60 gold: sell green potion</span>"}
              [show_if]
                {SXC_CMP green_potions_$side_number numerical_not_equals 0}
                {SXC_CMP green_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_greenp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=60
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP green_potions_$side_number add -1}
                {VARIABLE_OP green_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-green-sell.png" "<span color='#FF4040'>+48 gold: sell green potion</span>"}
              [show_if]
                {SXC_CMP green_potions_$side_number numerical_not_equals 0}
                {SXC_CMP green_potions numerical_equals 0}
                {SXC_CMP allow_shop_greenp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=48
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP green_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-green-buy.png" "<span color='#40FF40'>60 gold: buy green potion (extra attack, +100HP, heal slow & poison)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP green_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_greenp equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 60}
                  [then]
                    [gold]
                      amount=-60
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP green_potions_$side_number add 1}
                    {VARIABLE_OP green_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-orange-sell.png" "<span color='#FF4040'>+50 gold: sell orange potion</span>"}
              [show_if]
                {SXC_CMP orange_potions_$side_number numerical_not_equals 0}
                {SXC_CMP orange_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_orangep equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=50
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP orange_potions_$side_number add -1}
                {VARIABLE_OP orange_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-orange-sell.png" "<span color='#FF4040'>+40 gold: sell orange potion</span>"}
              [show_if]
                {SXC_CMP orange_potions_$side_number numerical_not_equals 0}
                {SXC_CMP orange_potions numerical_equals 0}
                {SXC_CMP allow_shop_orangep equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=40
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP orange_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-orange-buy.png" "<span color='#40FF40'>50 gold: buy orange potion (skirmish ability for 1 turn)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP orange_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_orangep equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 50}
                  [then]
                    [gold]
                      amount=-50
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP orange_potions_$side_number add 1}
                    {VARIABLE_OP orange_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-pink-sell.png" "<span color='#FF4040'>+50 gold: sell pink potion</span>"}
              [show_if]
                {SXC_CMP pink_potions_$side_number numerical_not_equals 0}
                {SXC_CMP pink_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_pinkp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=50
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP pink_potions_$side_number add -1}
                {VARIABLE_OP pink_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-pink-sell.png" "<span color='#FF4040'>+40 gold: sell pink potion</span>"}
              [show_if]
                {SXC_CMP pink_potions_$side_number numerical_not_equals 0}
                {SXC_CMP pink_potions numerical_equals 0}
                {SXC_CMP allow_shop_pinkp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=40
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP pink_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-pink-buy.png" "<span color='#40FF40'>50 gold: buy pink potion (flying for 1 turn)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP pink_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_pinkp equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 50}
                  [then]
                    [gold]
                      amount=-50
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP pink_potions_$side_number add 1}
                    {VARIABLE_OP pink_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-red-sell.png" "<span color='#FF4040'>+50 gold: sell red potion</span>"}
              [show_if]
                {SXC_CMP red_potions_$side_number numerical_not_equals 0}
                {SXC_CMP red_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_redp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=50
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP red_potions_$side_number add -1}
                {VARIABLE_OP red_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-red-sell.png" "<span color='#FF4040'>+40 gold: sell red potion</span>"}
              [show_if]
                {SXC_CMP red_potions_$side_number numerical_not_equals 0}
                {SXC_CMP red_potions numerical_equals 0}
                {SXC_CMP allow_shop_redp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=40
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP red_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-red-buy.png" "<span color='#40FF40'>50 gold: buy red potion (full HP, heal slow &amp; poison)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP red_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_redp equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 50}
                  [then]
                    [gold]
                      amount=-50
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP red_potions_$side_number add 1}
                    {VARIABLE_OP red_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-violet-sell.png" "<span color='#FF4040'>+0 gold: sell violet potion</span>"}
              [show_if]
                {SXC_CMP violet_potions_$side_number numerical_not_equals 0}
                {SXC_CMP violet_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_violetp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP violet_potions_$side_number add -1}
                {VARIABLE_OP violet_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-violet-sell.png" "<span color='#FF4040'>+0 gold: sell violet potion</span>"}
              [show_if]
                {SXC_CMP violet_potions_$side_number numerical_not_equals 0}
                {SXC_CMP violet_potions numerical_equals 0}
                {SXC_CMP allow_shop_violetp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP violet_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-violet-buy.png" "<span color='#40FF40'>0 gold: buy violet potion (not defined yet)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP violet_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_violetp equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 0}
                  [then]
                    [gold]
                      amount=-0
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP violet_potions_$side_number add 1}
                    {VARIABLE_OP violet_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-white-sell.png" "<span color='#FF4040'>+0 gold: sell white potion</span>"}
              [show_if]
                {SXC_CMP white_potions_$side_number numerical_not_equals 0}
                {SXC_CMP white_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_whitep equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP white_potions_$side_number add -1}
                {VARIABLE_OP white_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-white-sell.png" "<span color='#FF4040'>+0 gold: sell white potion</span>"}
              [show_if]
                {SXC_CMP white_potions_$side_number numerical_not_equals 0}
                {SXC_CMP white_potions numerical_equals 0}
                {SXC_CMP allow_shop_whitep equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP white_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-white-buy.png" "<span color='#40FF40'>0 gold: buy white potion (not defined yet)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP white_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_whitep equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 0}
                  [then]
                    [gold]
                      amount=-0
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP white_potions_$side_number add 1}
                    {VARIABLE_OP white_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-yellow-sell.png" "<span color='#FF4040'>+125 gold: sell yellow potion</span>"}
              [show_if]
                {SXC_CMP yellow_potions_$side_number numerical_not_equals 0}
                {SXC_CMP yellow_potions numerical_not_equals 0}
                {SXC_CMP allow_shop_yellowp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=125
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP yellow_potions_$side_number add -1}
                {VARIABLE_OP yellow_potions add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-yellow-sell.png" "<span color='#FF4040'>+100 gold: sell yellow potion</span>"}
              [show_if]
                {SXC_CMP yellow_potions_$side_number numerical_not_equals 0}
                {SXC_CMP yellow_potions numerical_equals 0}
                {SXC_CMP allow_shop_yellowp equals "yes"}
              [/show_if]
              [command]
                [gold]
                  amount=100
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP yellow_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message={MENU_IMG_TXT "icons/potion-yellow-buy.png" "<span color='#40FF40'>125 gold: buy yellow potion (+20HP, full HP, heal slow &amp; poison, 2x HP)</span>"}
              [show_if]
                {SXC_CMP potions_total_$side_number less_than 4}
                {SXC_CMP yellow_potions_$side_number less_than 2}
                {SXC_CMP allow_shop_yellowp equals "yes"}
              [/show_if]
              [command]
                [if]
                  {SXC_CMP gold  greater_than_equal_to 125}
                  [then]
                    [gold]
                      amount=-125
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP yellow_potions_$side_number add 1}
                    {VARIABLE_OP yellow_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
          [/message]
          [redraw]
          [/redraw]
          {CLEAR_VARIABLE potions_list}
        [/do]
      [/while]
      {CLEAR_VARIABLE black_potions}
      {CLEAR_VARIABLE blue_potions}
      {CLEAR_VARIABLE brown_potions}
      {CLEAR_VARIABLE cyan_potions}
      {CLEAR_VARIABLE grey_potions}
      {CLEAR_VARIABLE green_potions}
      {CLEAR_VARIABLE orange_potions}
      {CLEAR_VARIABLE pink_potions}
      {CLEAR_VARIABLE red_potions}
      {CLEAR_VARIABLE violet_potions}
      {CLEAR_VARIABLE white_potions}
      {CLEAR_VARIABLE yellow_potions}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SXC_IDENTIFY_SPECIALS VAR INDEX
  {VARIABLE specials_count_{INDEX} 0}
  {VARIABLE specials_price_{INDEX} 0}
  {FOREACH {VAR} specials_i}
    {SXC_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].attacks {INDEX}}
    {SXC_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].berserk {INDEX}}
    {SXC_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].chance_to_hit {INDEX}}
    {SXC_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].damage {INDEX}}
    {SXC_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].dummy {INDEX}}
    {SXC_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].drains {INDEX}}
    {SXC_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].firststrike {INDEX}}
    {SXC_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].poison {INDEX}}
    {SXC_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].slow {INDEX}}
  {NEXT specials_i}
  [set_variable]
    name=specials_list_{INDEX}
    [join]
      variable=specials_array_{INDEX}
      key=name
      separator=,
    [/join]
  [/set_variable]
  [if]
    {SXC_CMP specials_array_{INDEX}.length greater_than 0}
    [then]
      {VARIABLE specials_list_{INDEX} " ($specials_list_{INDEX}|)"}
    [/then]
    [else]
      {VARIABLE specials_list_{INDEX} " "}
    [/else]
  [/if]
#enddef

#define SXC_IDENTIFY_SPECIALS_ID VAR INDEX
  {FOREACH {VAR} specials_j}
    {VARIABLE duplicated no}
    {FOREACH specials_array_{INDEX} spec_dupl}
      [if]
        {SXC_CMP {VAR}[$specials_j|].id equals $specials_array_{INDEX}[$spec_dupl|].id}
        [then]
          {VARIABLE duplicated yes}
          [if]
            {SXC_CMP specials_array_{INDEX}[$spec_dupl|].name equals $null}
            [then]
              {VARIABLE specials_array_{INDEX}[$spec_dupl|].name ${VAR}[$specials_j|].name}
            [/then]
          [/if]
        [/then]
      [/if]
    {NEXT spec_dupl}
    [if]
      {SXC_CMP duplicated equals no}
      [then]
        {VARIABLE specials_array_{INDEX}[$specials_count_{INDEX}|].id ${VAR}[$specials_j|].id}
        {VARIABLE specials_array_{INDEX}[$specials_count_{INDEX}|].name ${VAR}[$specials_j|].name}
        {VARIABLE price 0}
        {SXC_IFSPEC {VAR}[$specials_j|].id absorb 200}
        {SXC_IFSPEC {VAR}[$specials_j|].id absorb 200}
        {SXC_IFSPEC {VAR}[$specials_j|].id arson 30}
        {SXC_IFSPEC {VAR}[$specials_j|].id attack_only 20}
        {SXC_IFSPEC {VAR}[$specials_j|].id backstab 24}
        {SXC_IFSPEC {VAR}[$specials_j|].id berserk 180}
        {SXC_IFSPEC {VAR}[$specials_j|].id berserk2 180}
        {SXC_IFSPEC {VAR}[$specials_j|].id blind 1}
        {SXC_IFSPEC {VAR}[$specials_j|].id charge 36}
        {SXC_IFSPEC {VAR}[$specials_j|].id charm 40}
        {SXC_IFSPEC {VAR}[$specials_j|].id circle 80}
        {SXC_IFSPEC {VAR}[$specials_j|].id cleave 5}
        {SXC_IFSPEC {VAR}[$specials_j|].id concentrated 250}
        {SXC_IFSPEC {VAR}[$specials_j|].id counter 30}
        {SXC_IFSPEC {VAR}[$specials_j|].id defend_only 10}
        {SXC_IFSPEC {VAR}[$specials_j|].id drains 200}
        {SXC_IFSPEC {VAR}[$specials_j|].id dread 40}
        {SXC_IFSPEC {VAR}[$specials_j|].id evade 36}
        {SXC_IFSPEC {VAR}[$specials_j|].id evasion 40}
        {SXC_IFSPEC {VAR}[$specials_j|].id ferocious 40}
        {SXC_IFSPEC {VAR}[$specials_j|].id firststrike 5}
        {SXC_IFSPEC {VAR}[$specials_j|].id focus 90}
        {SXC_IFSPEC {VAR}[$specials_j|].id guided 20}
        {SXC_IFSPEC {VAR}[$specials_j|].id highground 10}
        {SXC_IFSPEC {VAR}[$specials_j|].id magical 50}
        {SXC_IFSPEC {VAR}[$specials_j|].id marksman 42}
        {SXC_IFSPEC {VAR}[$specials_j|].id massivestrike 15}
        {SXC_IFSPEC {VAR}[$specials_j|].id nocounter 80}
        {SXC_IFSPEC {VAR}[$specials_j|].id poison 10}
        {SXC_IFSPEC {VAR}[$specials_j|].id precision 72}
        {SXC_IFSPEC {VAR}[$specials_j|].id rage 90}
        {SXC_IFSPEC {VAR}[$specials_j|].id rage2 60}
        {SXC_IFSPEC {VAR}[$specials_j|].id rage3 90}
        {SXC_IFSPEC {VAR}[$specials_j|].id recieve 5}
        {SXC_IFSPEC {VAR}[$specials_j|].id return 10}
        {SXC_IFSPEC {VAR}[$specials_j|].id slow 36}
        {SXC_IFSPEC {VAR}[$specials_j|].id spread 5}
        {SXC_IFSPEC {VAR}[$specials_j|].id sxc_berserk 180}
        {SXC_IFSPEC {VAR}[$specials_j|].id sxc_evade 36}
        {SXC_IFSPEC {VAR}[$specials_j|].id sxc_focus 90}
        {SXC_IFSPEC {VAR}[$specials_j|].id sxc_precision 72}
        {SXC_IFSPEC {VAR}[$specials_j|].id sxc_rage 90}
        {SXC_IFSPEC {VAR}[$specials_j|].id triplestrike 10}
        {SXC_IFSPEC {VAR}[$specials_j|].id udbane 10}
        {VARIABLE specials_array_{INDEX}[$specials_count_{INDEX}|].price $price}
        {VARIABLE_OP specials_price_{INDEX} add $price}
        {VARIABLE_OP specials_count_{INDEX} add 1}
        {CLEAR_VARIABLE price}
      [/then]
    [/if]
  {NEXT specials_j}
#enddef

#define SXC_IFSPEC ID REF VALUE
  [if]
    {SXC_CMP {ID} equals {REF}}
    [then]
      {VARIABLE price {VALUE}}
    [/then]
  [/if]
#enddef

#define SXC_BUY_WEAPON ICON NAME ID RNG TYPE DMG STR IMAGE HITS MISSES
  [option]
    [show_if]
      {SXC_CMP weapon_j less_than 8}
      {SXC_CMP hide_{RNG}_$side_number equals no}
    [/show_if]
    message={MENU_IMG_TXT {ICON} "<span color='#80FF80'>40 gold: buy {NAME}: {RNG} {TYPE} {DMG} - {STR}</span>"}
    [command]
      [if]
        {SXC_CMP gold greater_than_equal_to 40}
        [then]
          {VARIABLE damage {DMG}}
          {VARIABLE_OP damage add ${RNG}_damage_$side_number||}
          {VARIABLE strikes {STR}}
          {VARIABLE_OP strikes add ${RNG}_strikes_$side_number||}
          [object]
            silent=yes
            duration=forever
            [effect]
              apply_to=new_attack
              name="sxc_{ID}_$weapons_index|"
              description="{NAME}"
              damage=$damage
              number=$strikes
              range={RNG}
              type={TYPE}
              icon={IMAGE}
            [/effect]
            [effect]
              apply_to=new_animation
              [attack_anim]
                [filter_attack]
                  name="sxc_{ID}_$weapons_index|"
                [/filter_attack]
                [frame]
                  begin=-200
                  end=-150
                [/frame]
                [if]
                  hits=yes
                  [frame]
                    begin=-150
                    end=100
                    sound={HITS}
                  [/frame]
                [/if]
                [else]
                  hits=no
                  [frame]
                    begin=-150
                    end=100
                    sound={MISSES}
                  [/frame]
                [/else]
                [frame]
                  begin=100
                  end=200
                [/frame]
              [/attack_anim]
            [/effect]
          [/object]
          {VARIABLE weapons_bought "$weapons_bought|sxc_{ID}_$weapons_index|,"}
          {VARIABLE_OP weapons_index add 1}
          [gold]
            side=$side_number
            amount=-40
          [/gold]
          {CLEAR_VARIABLE damage}
          {CLEAR_VARIABLE strikes}
        [/then]
      [/if]
    [/command]
  [/option]
#enddef

#define SXC_SELL_WEAPON INDEX
  [option]
    [show_if]
      {SXC_CMP weapon_j greater_than {INDEX}}
      {SXC_CMP hide_$range_{INDEX}|_$side_number equals no}
      [and]
        {SXC_CMP maximum_level_reached_$side_number equals "yes"}
        [or]
          {SXC_CMP name_{INDEX} contains "sxc_"}
        [/or]
      [/and]
    [/show_if]
    message={MENU_IMG_TXT "icons/weapon-sell.png" "<span color='#FF8080'>$sell_text_{INDEX}</span>"}
    [command]
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=remove_attacks
          name=$name_{INDEX}
          type=$type_{INDEX}
          range=$range_{INDEX}
        [/effect]
      [/object]
      [gold]
        side=$side_number
        amount=$price_{INDEX}
      [/gold]
    [/command]
  [/option]
#enddef

#define SXC_SHOP_SPECIALS_SET INDEX
  [option]
    [show_if]
      {SXC_CMP weapon_j greater_than {INDEX}}
      {SXC_CMP hide_$range_{INDEX}|_$side_number equals no}
      [and]
        {SXC_CMP maximum_level_reached_$side_number equals "yes"}
        [or]
          {SXC_CMP name_{INDEX} contains "sxc_"}
        [/or]
      [/and]
    [/show_if]
    message={MENU_IMG_TXT "icons/special-weapon-select.png" "<span color='#FFFF80'>$select_text_{INDEX}</span>"}
    [command]
      [message]
        speaker=narrator
        message="<span weight='bold'>Select special to remove and sell or buy new
for the weapon you just selected. If you have
already 1 special attached, the price will go
up 50% against normal prices. If you have 2 or
more specials, then you can only remove and
sell them. Sell price is 60% of normal price.</span>
<span color='#E0E018'>Gold: $gold|</span>"
        image="icons/specials.png"
        [option]
          message={MENU_IMG_TXT "icons/no-changes.png" "No changes"}
          [command]
          [/command]
        [/option]
        {SXC_REMOVE_SPECIAL {INDEX} 0}
        {SXC_REMOVE_SPECIAL {INDEX} 1}
        {SXC_REMOVE_SPECIAL {INDEX} 2}
        {SXC_REMOVE_SPECIAL {INDEX} 3}
        {SXC_REMOVE_SPECIAL {INDEX} 4}
        {SXC_REMOVE_SPECIAL {INDEX} 5}
        {SXC_REMOVE_SPECIAL {INDEX} 6}
        {SXC_REMOVE_SPECIAL {INDEX} 7}
        {SXC_ADD_FIRST_SPECIAL {INDEX} backstab BACKSTAB 40 (Doubles damage when unit attacks from opposite side of enemy.)}
        {SXC_ADD_FIRST_SPECIAL {INDEX} berserk SXC_BERSERK 300 (Presses engagement until death of one combatant or 10 rounds
        of attacks occurred. This special is only active on offense.)}
        {SXC_ADD_FIRST_SPECIAL {INDEX} charge CHARGE 60 (While used offensive, it doubles damage for both combatants.)}
        {SXC_ADD_FIRST_SPECIAL {INDEX} evade SXC_EVADE 60 (Unit takes one third less damage while using this weapon.)}
        {SXC_ADD_FIRST_SPECIAL {INDEX} focus SXC_FOCUS 150 (Attack has 70% chance to hit and does 50% more
        damage to both combatants while used offensively.)}
        {SXC_ADD_FIRST_SPECIAL {INDEX} magical MAGICAL 90 (Attack has always 70% chance to hit.)}
        {SXC_ADD_FIRST_SPECIAL {INDEX} marksman MARKSMAN 70 (Attack has 60% chance to hit while used offensively.)}
        {SXC_ADD_FIRST_SPECIAL {INDEX} precision SXC_PRECISION 120 (This attack always has 80% chance of hit.)}
        {SXC_ADD_FIRST_SPECIAL {INDEX} rage SXC_RAGE 150 (Presses engagement until 3 rounds of attacks occured
        or until one of combatants is slain.)}
        {SXC_ADD_FIRST_SPECIAL {INDEX} slow SLOW 60 (Opponent will be slowed until end of turn
        while this attack hits it's target.)}
        {SXC_ADD_SECOND_SPECIAL {INDEX} backstab BACKSTAB 60 (Doubles damage when unit attacks from opposite side of enemy.)}
        {SXC_ADD_SECOND_SPECIAL {INDEX} berserk SXC_BERSERK 450 (Presses engagement until death of one combatant or 10 rounds
        of attacks occurred. This special is only active on offense.)}
        {SXC_ADD_SECOND_SPECIAL {INDEX} charge CHARGE 90 (While used offensive, it doubles damage for both combatants.)}
        {SXC_ADD_SECOND_SPECIAL {INDEX} evade SXC_EVADE 90 (Unit takes one third less damage while using this weapon.)}
        {SXC_ADD_SECOND_SPECIAL {INDEX} focus SXC_FOCUS 225 (Attack has 70% chance to hit and does 50% more
        damage to both combatants while used offensively.)}
        {SXC_ADD_SECOND_SPECIAL {INDEX} magical MAGICAL 145 (Attack has always 70% chance to hit.)}
        {SXC_ADD_SECOND_SPECIAL {INDEX} marksman MARKSMAN 105 (Attack has 60% chance to hit while used offensively.)}
        {SXC_ADD_SECOND_SPECIAL {INDEX} precision SXC_PRECISION 180 (This attack always has 80% chance of hit.)}
        {SXC_ADD_SECOND_SPECIAL {INDEX} rage SXC_RAGE 225 (Presses engagement until 3 rounds of attacks occured
        or until one of combatants is slain.)}
        {SXC_ADD_SECOND_SPECIAL {INDEX} slow SLOW 90 (Opponent will be slowed until end of turn
        while this attack hits it's target.)}
      [/message]
      [redraw]
      [/redraw]
    [/command]
  [/option]
#enddef

#define SXC_REMOVE_SPECIAL INDEX INDEX2
  [option]
    [show_if]
      {SXC_CMP specials_count_{INDEX} greater_than {INDEX2}}
    [/show_if]
    message={MENU_IMG_TXT "icons/weapon-sell.png" "<span color='#FF8080'>+$specials_array_{INDEX}[{INDEX2}].price| gold: remove $specials_array_{INDEX}[{INDEX2}].name|</span>"}
    [command]
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=attack
          name=$name_{INDEX}
          type=$type_{INDEX}
          range=$range_{INDEX}
          remove_specials=$specials_array_{INDEX}[{INDEX2}].id
        [/effect]
      [/object]
      [gold]
        amount=$specials_array_{INDEX}[{INDEX2}].price
        side=$side_number
      [/gold]
    [/command]
  [/option]
#enddef

#define SXC_ARMORY_TYPE TYPE
  [option]
    [show_if]
      {SXC_CMP {TYPE}_session greater_than 0}
      {SXC_CMP {TYPE}_extra numerical_equals 0}
    [/show_if]
    message={MENU_IMG_TXT "icons/{TYPE}-sell.png" "<span color='#FF8080'>+8 gold: sell 5% of {TYPE} resistance</span>"}
    [command]
      [gold]
        amount=8
        side=$side_number
      [/gold]
      {VARIABLE_OP {TYPE}_session add -5}
      {SXC_SET_RESISTANCE {TYPE} 5}
    [/command]
  [/option]
  [option]
    [show_if]
      {SXC_CMP {TYPE}_extra greater_than 0}
      [or]
        {SXC_CMP current_{TYPE} greater_than_equal_to 100}
      [/or]
    [/show_if]
    message={MENU_IMG_TXT "icons/{TYPE}-sell.png" "<span color='#FF8080'>+15 gold: sell 5% of EXTRA {TYPE} resistance</span>"}
    [command]
      [gold]
        amount=15
        side=$side_number
      [/gold]
      {VARIABLE_OP {TYPE}_session add -5}
      {VARIABLE_OP {TYPE}_extra add -5}
      {VARIABLE_OP extra_armor_bought_$side_number add -5}
      {SXC_SET_RESISTANCE {TYPE} 5}
    [/command]
  [/option]
  [option]
    [show_if]
      {SXC_CMP armor_limit_$side_number greater_than $current_{TYPE}}
    [/show_if]
    message={MENU_IMG_TXT "icons/{TYPE}-buy.png" "<span color='#80FF80'>8 gold: buy +5% {TYPE} resistance</span>"}
    [command]
      [if]
        {SXC_CMP gold greater_than_equal_to 8}
        [then]
          [gold]
            amount=-8
            side=$side_number
          [/gold]
          {VARIABLE_OP {TYPE}_session add 5}
          {SXC_SET_RESISTANCE {TYPE} -5}
        [/then]
      [/if]
    [/command]
  [/option]
  [option]
    [show_if]
      {SXC_CMP armor_limit_$side_number less_than_equal_to $current_{TYPE}}
      {SXC_CMP current_{TYPE} less_than_equal_to 95}
      {SXC_CMP armor_total_$side_number greater_than $extra}
    [/show_if]
    message={MENU_IMG_TXT "icons/{TYPE}-buy.png" "<span color='#80FF80'>15 gold: buy +5% EXTRA {TYPE} resistance</span>"}
    [command]
      [if]
        {SXC_CMP gold greater_than_equal_to 15}
        [then]
          [gold]
            amount=-15
            side=$side_number
          [/gold]
          {VARIABLE_OP {TYPE}_session add 5}
          {VARIABLE_OP {TYPE}_extra add 5}
          {VARIABLE_OP extra_armor_bought_$side_number add 5}
          {SXC_SET_RESISTANCE {TYPE} -5}
        [/then]
      [/if]
    [/command]
  [/option]
#enddef

#define SXC_SET_RESISTANCE TYPE AMOUNT
  [object]
    silent=yes
    duration=forever
    [effect]
      apply_to=resistance
      replace=no
      [resistance]
        {TYPE}={AMOUNT}
      [/resistance]
    [/effect]
  [/object]
#enddef

#define SXC_TRAINING_CHECK TRAINVAR
  [if]
    {SXC_CMP {TRAINVAR}_$side_number numerical_equals 1}
    [then]
      {VARIABLE {TRAINVAR} "trained"}
    [/then]
    [else]
      {VARIABLE {TRAINVAR} "       "}
    [/else]
  [/if]
#enddef

#define SXC_ADD_FIRST_SPECIAL INDEX ID ID2 PRICE DESCRIPTION
  [option]
    [show_if]
      {SXC_CMP specials_count_{INDEX} numerical_equals 0}
      {SXC_CMP $range_{INDEX}|_specials contains {ID}}
    [/show_if]
    message= {MENU_IMG_TXT "icons/add-special-{ID}.png" "<span color='#80FF80'>{PRICE} gold: add {ID} to $description_{INDEX}</span>
<span size='small'>{DESCRIPTION}</span>"}
    [command]
      [if]
        {SXC_CMP gold greater_than_equal_to {PRICE}}
        [then]
          [gold]
            amount=-{PRICE}
            side=$side_number
          [/gold]
          [object]
            silent=yes
            duration=forever
            [effect]
              apply_to=attack
              name=$name_{INDEX}
              type=$type_{INDEX}
              range=$range_{INDEX}
              [set_specials]
                {WEAPON_SPECIAL_{ID2}}
              [/set_specials]
            [/effect]
          [/object]
        [/then]
      [/if]
    [/command]
  [/option]
#enddef

#define SXC_ADD_SECOND_SPECIAL INDEX ID ID2 PRICE DESCRIPTION
  [option]
    [show_if]
      {SXC_CMP specials_count_{INDEX} numerical_equals 1}
      {SXC_CMP $range_{INDEX}|_specials contains {ID}}
      {SXC_CMP {ID}_combinations contains ",$specials_array_{INDEX}[0].id,"}
    [/show_if]
    message={MENU_IMG_TXT "icons/add-special-{ID}.png" "<span color='#80FF80'>{PRICE} gold: add {ID} to $description_{INDEX}</span>
<span size='small'>{DESCRIPTION}</span>"}
    [command]
      [if]
        {SXC_CMP gold greater_than_equal_to {PRICE}}
        [then]
          [gold]
            amount=-{PRICE}
            side=$side_number
          [/gold]
          [object]
            silent=yes
            duration=forever
            [effect]
              apply_to=attack
              name=$name_{INDEX}
              type=$type_{INDEX}
              range=$range_{INDEX}
              [set_specials]
                mode=append
                {WEAPON_SPECIAL_{ID2}}
              [/set_specials]
            [/effect]
          [/object]
        [/then]
      [/if]
    [/command]
  [/option]
#enddef

#define SXC_KILL
  [event]
    name=prestart
    {VARIABLE event_index 0}
    {VARIABLE luck 0}
    {VARIABLE specialevent 0}
    {VARIABLE specialtask 0}
    {VARIABLE specialtrap 0}
    {VARIABLE leader6 1}
    {VARIABLE leader7 1}
    {VARIABLE leader8 1}
    {VARIABLE leader9 1}
    {VARIABLE cornucopia 0}
    {VARIABLE killbonus_0_0 5}
    {VARIABLE killbonus_0_1 10}
    {VARIABLE killbonus_0_2 15}
    {VARIABLE killbonus_0_3 20}
    {VARIABLE killbonus_0_4 25}
    {VARIABLE killbonus_0_5 30}
    {VARIABLE killbonus_1_0 10}
    {VARIABLE killbonus_1_1 20}
    {VARIABLE killbonus_1_2 30}
    {VARIABLE killbonus_1_3 40}
    {VARIABLE killbonus_1_4 50}
    {VARIABLE killbonus_1_5 60}
    {VARIABLE killbonus_2_0 15}
    {VARIABLE killbonus_2_1 30}
    {VARIABLE killbonus_2_2 45}
    {VARIABLE killbonus_2_3 60}
    {VARIABLE killbonus_2_4 75}
    {VARIABLE killbonus_2_5 90}
  [/event]

  [event]
    name=die
    first_time_only=no
    [filter_second]
      [filter_side]
        team_name=Heroes
      [/filter_side]
    [/filter_second]
    [store_unit]
      variable=victim
      [filter]
        x,y=$x1,$y1
      [/filter]
    [/store_unit]
    [if]
      {SXC_CMP victim.role equals "big_boss"}
      [then]
        {VARIABLE isHero 2}
      [/then]
      [else]
        [if]
          {SXC_CMP victim.role equals "boss"}
          [or]
            {SXC_CMP victim.role equals "guard"}
          [/or]
          [then]
            {VARIABLE isHero 1}
          [/then]
          [else]
            {VARIABLE isHero 0}
          [/else]
        [/if]
      [/else]
    [/if]
    {VARIABLE bonus $killbonus_$isHero|_$victim.level}
    [if]
      {SXC_CMP cornucopia equals 1}
      [then]
        {VARIABLE_OP bonus multiply 1.2}
      [/then]
    [/if]
    [if]
      {SXC_CMP turn_number greater_than_equal_to $cashstop_$victim.side}
      [then]
        {VARIABLE bonus 0}
      [/then]
    [/if]
    [if]
      {SXC_CMP victim.role equals "recruits"}
      [then]
        {VARIABLE_OP recruits_$victim.side| sub 1}
      [/then]
    [/if]
    {CLEAR_VARIABLE victim}
    [store_unit]
      [filter]
        x=$x2
        y=$y2
      [/filter]
      variable=killer
    [/store_unit]
    {VARIABLE killer.moves $mp_kill_$killer.side}
    {VARIABLE killer.attacks_left 1}
    {CLEAR_VARIABLE killer.status.poisoned}
    {CLEAR_VARIABLE killer.status.slowed}
    [unstore_unit]
      variable=killer
    [/unstore_unit]
    {CLEAR_VARIABLE killer}
    {VARIABLE i 1}
    [while]
      {SXC_CMP i less_than_equal_to 5}
      [do]
        [if]
          [have_unit]
            side=$i
            canrecruit=yes
          [/have_unit]
          [then]
            [gold]
              side=$i
              amount=$bonus
            [/gold]
            [store_unit]
              [filter]
                side=$i
                canrecruit=yes
              [/filter]
              variable=killers
            [/store_unit]
            [unstore_unit]
              variable=killers
              text=$bonus
              red,green,blue=255,255,0
            [/unstore_unit]
            {VARIABLE_OP income_$i| add $bonus}
            {CLEAR_VARIABLE killers}
          [/then]
        [/if]
        [sound]
          name=gold.ogg
        [/sound]
        {VARIABLE_OP i add 1}
      [/do]
    [/while]
    {CLEAR_VARIABLE i}
  [/event]
#enddef

#define SXC_MODIFY_INCOME SIDE INCOME
  [modify_side]
    side={SIDE}
    income={INCOME}
  [/modify_side]
#enddef

#define SXC_ENEMY_DEATH_EVENT
  [event]
    name=die
    first_time_only=no
    [filter]
      role=boss
    [/filter]
    {VARIABLE id $unit.id}
    {FOREACH moving_bosses i}
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals CHEST_GOLD}
        [then]
          {SXC_CHEST_GOLD $unit.x $unit.y $moving_bosses[$i|].amount|}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals DEFRING}
        [then]
          {SXC_DEFRING $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals RESRING}
        [then]
          {SXC_RESRING $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals BLUE_POTION}
        [then]
          {SXC_BLUE_POTION $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals CYAN_POTION}
        [then]
          {SXC_CYAN_POTION $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals RED_POTION}
        [then]
          {SXC_RED_POTION $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals YELLOW_POTION}
        [then]
          {SXC_YELLOW_POTION $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals SPIRITSTAFF}
        [then]
          {SXC_SPIRITSTAFF $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals BUCKLER}
        [then]
          {SXC_BUCKLER $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals BARREL}
        [then]
          {SXC_BARREL $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals DWARFPLATE}
        [then]
          {SXC_DWARFPLATE $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals RINGDARKNESS}
        [then]
          {SXC_RINGDARKNESS $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals FIREARMOR}
        [then]
          {SXC_FIREARMOR $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals ICEARMOR}
        [then]
          {SXC_ICEARMOR $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals TARGET}
        [then]
          {SXC_TARGET $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals NECKLACE}
        [then]
          {SXC_NECKLACE $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals BOW}
        [then]
          {SXC_BOW $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals SWORD}
        [then]
          {SXC_SWORD $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals SCEPTRE}
        [then]
          {SXC_SCEPTRE $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals CLOAK}
        [then]
          {SXC_CLOAK $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SXC_CMP moving_bosses[$i|].id equals $id}
        {SXC_CMP moving_bosses[$i|].type equals CORNUCOPIA}
        [then]
          {SXC_CORNUCOPIA $unit.x $unit.y}
        [/then]
      [/if]
    {NEXT i}
  [/event]
#enddef

#define SXC_CHOOSE_DIFFICULTY X Y
  [event]
    name=moveto
    first_time_only=yes
    [filter]
      [filter_side]
        team_name=Heroes
      [/filter_side]
    [/filter]
    {VARIABLE show_help "no"}
    [message]
      speaker=narrator
      image=wesnoth-icon.png
      message="<span color='#8080FF' size='large'>Choose the difficulty.</span>
Your setting will affect the amount of gold you will gain by killing enemies,
as well as their toughness and strength. However, choose your difficulty
carefully as you can't change it anymore later."
      [option]
        message={MENU_IMG_TXT "units/human-peasants/woodsman.png" "<span color='#00FF00'>Rookie</span>
<span size='small'>Beginners who never played Survival Xtreme maps before or still fail
at other difficulties should choose this difficulty. You will get some
hint messages at the start and when entering shop area for the first time.

This mode has also a resurrection function, if your unit dies and
at least one player unit stays alive at start of next turn, your unit will
revive with 1 health point at your starting position with all items and
upgrades it had at the moment it was killed.</span>"}
        [command]
          {VARIABLE killbonus_0_0 4}
          {VARIABLE killbonus_0_1 8}
          {VARIABLE killbonus_0_2 10}
          {VARIABLE killbonus_0_3 12}
          {VARIABLE killbonus_0_4 14}
          {VARIABLE killbonus_0_5 16}
          {VARIABLE killbonus_1_0 8}
          {VARIABLE killbonus_1_1 16}
          {VARIABLE killbonus_1_2 20}
          {VARIABLE killbonus_1_3 24}
          {VARIABLE killbonus_1_4 28}
          {VARIABLE killbonus_1_5 32}
          {VARIABLE killbonus_2_0 12}
          {VARIABLE killbonus_2_1 24}
          {VARIABLE killbonus_2_2 30}
          {VARIABLE killbonus_2_3 36}
          {VARIABLE killbonus_2_4 42}
          {VARIABLE killbonus_2_5 48}
          {VARIABLE_OP brutal add 0}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text= Difficulty: ROOKIE
            size=24
            duration=500
            red,green,blue=255,255,0
          [/print]
          {VARIABLE difficulty 25}
          {VARIABLE difficulty_text "Difficulty: ROOKIE"}
          {VARIABLE sxc_revive_mode "yes"}
          {VARIABLE sxc_revive_cost 0}
          {VARIABLE show_help "yes"}
        [/command]
      [/option]
      [option]
        message={MENU_IMG_TXT "units/human-loyalists/bowman.png" "<span color='#FFFF00'>Advanced</span>
<span size='small'>Choose this difficulty when you aready have some experience with
Survival Xtreme maps. Provides some challenge with high chance to win.</span>"}
        [command]
          {VARIABLE killbonus_0_0 3}
          {VARIABLE killbonus_0_1 6}
          {VARIABLE killbonus_0_2 8}
          {VARIABLE killbonus_0_3 10}
          {VARIABLE killbonus_0_4 12}
          {VARIABLE killbonus_0_5 14}
          {VARIABLE killbonus_1_0 6}
          {VARIABLE killbonus_1_1 12}
          {VARIABLE killbonus_1_2 16}
          {VARIABLE killbonus_1_3 20}
          {VARIABLE killbonus_1_4 24}
          {VARIABLE killbonus_1_5 28}
          {VARIABLE killbonus_2_0 9}
          {VARIABLE killbonus_2_1 18}
          {VARIABLE killbonus_2_2 24}
          {VARIABLE killbonus_2_3 30}
          {VARIABLE killbonus_2_4 36}
          {VARIABLE killbonus_2_5 42}
          {VARIABLE_OP brutal add 2}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text= Difficulty: ADVANCED
            size=24
            duration=500
            red,green,blue=255,128,0
          [/print]
          {VARIABLE difficulty 50}
          {VARIABLE difficulty_text "Difficulty: ADVANCED"}
        [/command]
      [/option]
      [option]
        message={MENU_IMG_TXT "units/human-magi/white-mage-melee-1.png" "<span color='#A5FF00'>Xtreme + Revive</span>
<span size='small'>The stats of Xtreme, with revive mode enabled. This comes from seeing
that the revive games (in rookie mode) enable a different playstyle.

In this mode each revive costs gold (which it doesn't in rookie mode),
you'll still revive even with negative gold.</span>"}
        [command]
          {VARIABLE killbonus_0_0 2}
          {VARIABLE killbonus_0_1 5}
          {VARIABLE killbonus_0_2 7}
          {VARIABLE killbonus_0_3 9}
          {VARIABLE killbonus_0_4 11}
          {VARIABLE killbonus_0_5 13}
          {VARIABLE killbonus_1_0 5}
          {VARIABLE killbonus_1_1 10}
          {VARIABLE killbonus_1_2 14}
          {VARIABLE killbonus_1_3 18}
          {VARIABLE killbonus_1_4 22}
          {VARIABLE killbonus_1_5 26}
          {VARIABLE killbonus_2_0 7}
          {VARIABLE killbonus_2_1 15}
          {VARIABLE killbonus_2_2 21}
          {VARIABLE killbonus_2_3 27}
          {VARIABLE killbonus_2_4 33}
          {VARIABLE killbonus_2_5 39}
          {VARIABLE_OP brutal add 5}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text= Difficulty: XTREME with Revive enabled
            size=32
            duration=750
            red,green,blue=165,255,0
          [/print]
          {VARIABLE difficulty 100}
          {VARIABLE difficulty_text "Difficulty: XTREME + REVIVE"}
          {VARIABLE sxc_revive_mode "yes"}
          {VARIABLE sxc_revive_cost 200}
        [/command]
      [/option]
      [option]
        message=*{MENU_IMG_TXT "units/human-loyalists/longbowman.png" "<span color='#FFA500'>Xtreme</span>
<span size='small'>This difficulty should provide good challenge and chance to win
for most players.</span>"}
        [command]
          {VARIABLE killbonus_0_0 2}
          {VARIABLE killbonus_0_1 5}
          {VARIABLE killbonus_0_2 7}
          {VARIABLE killbonus_0_3 9}
          {VARIABLE killbonus_0_4 11}
          {VARIABLE killbonus_0_5 13}
          {VARIABLE killbonus_1_0 5}
          {VARIABLE killbonus_1_1 10}
          {VARIABLE killbonus_1_2 14}
          {VARIABLE killbonus_1_3 18}
          {VARIABLE killbonus_1_4 22}
          {VARIABLE killbonus_1_5 26}
          {VARIABLE killbonus_2_0 7}
          {VARIABLE killbonus_2_1 15}
          {VARIABLE killbonus_2_2 21}
          {VARIABLE killbonus_2_3 27}
          {VARIABLE killbonus_2_4 33}
          {VARIABLE killbonus_2_5 39}
          {VARIABLE_OP brutal add 5}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text= Difficulty: XTREME
            size=32
            duration=750
            red,green,blue=255,0,0
          [/print]
          {VARIABLE difficulty 100}
          {VARIABLE difficulty_text "Difficulty: XTREME"}
          [music]
            name=frantic.ogg
            play_once=yes
            immediate=yes
          [/music]
        [/command]
      [/option]
      [option]
        message={MENU_IMG_TXT "units/human-loyalists/masterbowman.png" "<span color='#FF0000'>Mad Mode</span>
<span size='small'>This difficulty requires good teamplay and is for experienced players.
Provides most challenge and small chance to win with some portion
of good luck.</span>"}
        [command]
          {VARIABLE killbonus_0_0 2}
          {VARIABLE killbonus_0_1 4}
          {VARIABLE killbonus_0_2 6}
          {VARIABLE killbonus_0_3 8}
          {VARIABLE killbonus_0_4 10}
          {VARIABLE killbonus_0_5 12}
          {VARIABLE killbonus_1_0 4}
          {VARIABLE killbonus_1_1 8}
          {VARIABLE killbonus_1_2 12}
          {VARIABLE killbonus_1_3 16}
          {VARIABLE killbonus_1_4 20}
          {VARIABLE killbonus_1_5 24}
          {VARIABLE killbonus_2_0 6}
          {VARIABLE killbonus_2_1 12}
          {VARIABLE killbonus_2_2 18}
          {VARIABLE killbonus_2_3 24}
          {VARIABLE killbonus_2_4 30}
          {VARIABLE killbonus_2_5 36}
          {VARIABLE_OP brutal add 10}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text= Difficulty: MAD MODE
            size=40
            duration=1000
            red,green,blue=128,0,128
          [/print]
          {VARIABLE difficulty 200}
          {VARIABLE difficulty_text "Difficulty: MAD MODE"}
          [music]
            name=frantic.ogg
            play_once=yes
            immediate=yes
          [/music]
        [/command]
      [/option]
      image=wesnoth-icon.png
    [/message]
    [redraw]
    [/redraw]
    [label]
      x={X}
      y={Y}
      text="$difficulty_text|"
    [/label]
    [delay]
      time=1000
    [/delay]
    [set_menu_item]
      id=SXC_Active_Difficulty
      description="$difficulty_text|"
      [command]
        [fire_event]
          name=sxc_show_difficulty
        [/fire_event]
      [/command]
    [/set_menu_item]
    [if]
      {SXC_CMP show_help boolean_equals yes}
      [then]
        {VARIABLE helptext "<span color='#40FF40' size='large'>Help for beginners</span>
To show this help text any time later, right click and choose 'SXCollection Help'
from the context menu.
This addon works differently from the normal Wesnoth behavior. You have
only one unit and you can't recruit, but you can enhance your unit in shop.
This includes buying health points, improving damage of your attacks, number
of strikes, movement. You can also buy new weapons, add up to 2 specials
(total number of specials for any weapon, if you have more specials by default,
you can only remove them). Default weapons can only be altered (sold
or changed specials) when your unit has maximum level. Also, when your
unit gets it's maximum level, you can buy armor, up to 2 extra abilities to your
default abilities. You can also buy terrain training, so your unit can move faster
in terrains where it is slow or it's not able to move normally. For 20 gold you
can heal when you feel your health is too bad.
To access shop, go on the shop hex and right click on your unit, then select
'Enter Shop' from the menu. Before you will be able to buy anything, you must
select your range specialization. The other range training will cost double price
and your choice for specials in the other range will be limited to defensive
specials, though you can keep your default specials but when you remove
them, you can't buy them back.
Try to buy optimal improvements for your unit and keep in mind that your
income depends on the amount of enemy units killed by any player unit, gold
from chests and you get also some income every turn when an enemy leader
is dead but only as long as he stays dead.
Optimal upgrades at start are about 100HP (total value), terrain training for
up to 2 terrains (it is more expensive until you reach unit's maximum level but
it can be useful i.e. for mermen and flat terrain), then if you are not satisfied
with your default weapons, buy one extra (best with different attack type) and
buy good specials for it (assuming it's the range you selected at start, for melee
it's magical for units with lower terrain defense or rage for units with better
terrain defense and for ranged it's precision or focus. In both cases its good
to add slow as second special. For the other range - not selected at start -
it's good to buy evade because enemy often chooses the range with slow
because it's better chance that you don't hit and you will get more damage
than with evade which works always and also when you attack unit and you
don't kill it, evade will even lower the damage caused to you so it is more likely
that the unit will attack you with your favourited range and suicides on your
strong attack).
When you will kill an unit, you will get extra movement and you can attack again
in the same turn but only when you kill."}
        [message]
          speaker=narrator
          image=wesnoth-icon.png
          message="$helptext|
$maptext|"
        [/message]
        [set_menu_item]
          id=SXC_Help
          description="SXCollection Help"
          [command]
            [message]
              speaker=narrator
              image=wesnoth-icon.png
              side_for=$side_number
              message="$helptext|
$maptext|"
            [/message]
          [/command]
        [/set_menu_item]
      [/then]
    [/if]
    {CLEAR_VARIABLE show_help}
  [/event]

  [event]
    name=sxc_show_difficulty
    first_time_only=no
    {VARIABLE summary (_ "Brutal: $brutal|, Revive: $sxc_revive_mode|")}
    [if]
      {SXC_CMP sxc_revive_mode boolean_equals yes}
      [and]
        {SXC_CMP sxc_revive_cost not_equals 0}
      [/and]
      [then]
        {VARIABLE summary ($summary| + _ ", cost $sxc_revive_cost| (you can revive with negative gold)")}
      [/then]
    [/if]
    [store_side]
      team_name=Enemies
    [/store_side]
    [foreach]
      array=side
      [do]
        {VARIABLE number $this_item.side|}
        {VARIABLE summary ($summary| + "
" + _ "Recruits alive side $number|: $recruits_$number||")}
      [/do]
    [/foreach]
    [message]
      speaker=narrator
      message=$summary
      side_for=$side_number
      image=wesnoth-icon.png
    [/message]
    {CLEAR_VARIABLE summary}
  [/event]
#enddef

# When revive mode is on, the players will normally respawn at their starting locations. For Spooky
# Forest, the start is meant to be inaccessible after the first turn or two, and this allows the
# respawn to happen near the second shop instead.
#define SXC_SET_REVIVE_LOCATION X Y
  [set_variables]
    name=sxc_revive_location
    mode=replace
    [value]
      x={X}
      y={Y}
    [/value]
  [/set_variables]
#enddef

#define SXC_DEATH_MESSAGES
  [event]
    name=die
    first_time_only=no
    [filter]
      [filter_side]
        team_name=Heroes
      [/filter_side]
      canrecruit=yes
    [/filter]
    [store_unit]
      [filter]
        x,y=$x1,$y1
        canrecruit=yes
      [/filter]
      variable=dying_friend
    [/store_unit]
    [if]
      {SXC_CMP sxc_revive_mode boolean_equals yes}
      [then]
        [set_variables]
          name=death_texts
          to_variable=death_texts_revive
        [/set_variables]
        {VARIABLE death_text_suffix (_"
<span color='lightgreen'>Revive mode is on, the unit will respawn if at least one player unit survives this turn</span>")}
      [/then]
      [else]
        [set_variables]
          name=death_texts
          to_variable=death_texts_dead
        [/set_variables]
        {VARIABLE death_text_suffix ""}
      [/else]
    [/if]
    {RANDOM "0..$($death_texts.length - 1)"}
    [message]
      speaker=unit
      message="$death_texts[$random|].value| $death_text_suffix|"
    [/message]
    {CLEAR_VARIABLE death_texts}
    {CLEAR_VARIABLE death_text_suffix}
    [store_gold]
      side=$dying_friend.side
      variable=gold_die
    [/store_gold]
    [if]
      {SXC_CMP sxc_revive_mode boolean_equals yes}
      [then]
        {VARIABLE deads $sxc_revive_dead.length}
        [store_unit]
          [filter]
            x,y=$x1,$y1
            canrecruit=yes
          [/filter]
          variable=sxc_revive_dead[$deads|]
        [/store_unit]
        [if]
          [have_location]
            x=$sxc_revive_location.x
            x=$sxc_revive_location.y
          [/have_location]
          [then]
            [set_variables]
              name=revive_location
              to_variable=sxc_revive_location
            [/set_variables]
          [/then]
          [else]
            [store_starting_location]
              side=$dying_friend.side
              variable=revive_location
            [/store_starting_location]
          [/else]
        [/if]
        {VARIABLE sxc_revive_dead[$deads|].hitpoints 1}
        {VARIABLE sxc_revive_dead[$deads|].x $revive_location.x}
        {VARIABLE sxc_revive_dead[$deads|].y $revive_location.y}
        {VARIABLE sxc_revive_dead[$deads|].variables.gold $gold_die}
        {CLEAR_VARIABLE deads}
        {CLEAR_VARIABLE revive_location}
      [/then]
      [else]
        {VARIABLE i 1}
        [while]
          {SXC_CMP i less_than_equal_to 2}
          [do]
            [if]
              {SXC_CMP defring_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_DEFRING $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP resring_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_RESRING $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP blue_potions_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_BLUE_POTION $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP red_potions_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_RED_POTION $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP yellow_potions_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_YELLOW_POTION $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP cyan_potions_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_CYAN_POTION $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP target_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_TARGET $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP cloak_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_CLOAK $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP cornucopia_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_CORNUCOPIA $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP sceptre_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_SCEPTRE $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP sword_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_SWORD $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP bow_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_BOW $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP necklace_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_NECKLACE $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP icearmor_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_ICEARMOR $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP firearmor_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_FIREARMOR $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP spiritstaff_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_SPIRITSTAFF $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP buckler_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_BUCKLER $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP barrel_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_BARREL $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP dwarvishplate_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_DWARFPLATE $x1 $y1}
              [/then]
            [/if]
            [if]
              {SXC_CMP ringofdarkness_$dying_friend.side greater_than_equal_to $i}
              [then]
                {SXC_RINGDARKNESS $x1 $y1}
              [/then]
            [/if]
            {VARIABLE_OP i add 1}
          [/do]
        [/while]
        [if]
          {SXC_CMP gold_die greater_than_equal_to 1}
          {SXC_CMP shopped_$dying_friend.side greater_than 0}
          [then]
            {SXC_CHEST_GOLD $x1 $y1 $gold_die}
          [/then]
        [/if]
        [gold]
          amount=-$gold_die
          side=$dying_friend.side
        [/gold]
      [/else]
    [/if]
    {CLEAR_VARIABLE gold_die}
    {CLEAR_VARIABLE dying_friend}
    {CLEAR_VARIABLE random}
    {CLEAR_VARIABLE i}
  [/event]
  
  [event]
    name=new turn
    first_time_only=no
    [foreach]
      array=sxc_revive_dead
      [do]
        # The amount of gold at the end of this should be the amount that the player had at the
        # time of death (ignoring kills while the unit was dead), minus sxc_revive_cost, with a
        # minimum of (- sxc_revive_cost) so that a side doesn't become unrecoverable after multiple
        # deaths.
        [lua]
          code=<<
            local args = ...
            side = wesnoth.sides[args.side_number]
            if args.death_gold > 0 then
              side.gold = args.death_gold - args.revive_cost
            else
              side.gold = 0 - args.revive_cost
            end
          >>
          [args]
            side_number=$this_item.side
            death_gold=$this_item.variables.gold
            revive_cost=$sxc_revive_cost
          [/args]
        [/lua]
        [unstore_unit]
          variable=this_item
          find_vacant=yes
        [/unstore_unit]
        {SXC_REDRAW_TERRAIN}
      [/do]
    [/foreach]
    {CLEAR_VARIABLE sxc_revive_dead}
  [/event]
#enddef

#define SXC_ENEMY_UPGRADE_WEAPON DMG STR
  {RANDOM 0..5}
  [switch]
    variable=random
    [case]
      value=0
      {SXC_ENEMY_UPGRADE_WEAPON2 ARCANE {DMG} {STR}}
    [/case]
    [case]
      value=1
      {SXC_ENEMY_UPGRADE_WEAPON2 BLADE {DMG} {STR}}
    [/case]
    [case]
      value=2
      {SXC_ENEMY_UPGRADE_WEAPON2 COLD {DMG} {STR}}
    [/case]
    [case]
      value=3
      {SXC_ENEMY_UPGRADE_WEAPON2 FIRE {DMG} {STR}}
    [/case]
    [case]
      value=4
      {SXC_ENEMY_UPGRADE_WEAPON2 IMPACT {DMG} {STR}}
    [/case]
    [case]
      value=5
      {SXC_ENEMY_UPGRADE_WEAPON2 PIERCE {DMG} {STR}}
    [/case]
  [/switch]
#enddef

#define SXC_ENEMY_UPGRADE_WEAPON2 TYPE DMG STR
  [if]
    {SXC_CMP creep_attacks_melee less_than 1}
    [then]
      [object]
        silent=yes
        duration=forever
        {SXC_ENEMY_WEAPON_{TYPE} {DMG} {STR}}
      [/object]
    [/then]
  [/if]
  [if]
    {SXC_CMP creep_attacks_ranged less_than 1}
    [then]
      [object]
        silent=yes
        duration=forever
        {SXC_ENEMY_WEAPON_{TYPE}_MISSILE {DMG} {STR}}
      [/object]
    [/then]
  [/if]
#enddef

#define SXC_ENEMY_UPGRADE
  [event]
    name=recruit
    first_time_only=no
    [store_unit]
      [filter]
        x,y=$x1,$y1
        [filter_side]
          team_name=Enemies
        [/filter_side]
      [/filter]
      variable=creep
    [/store_unit]
    {VARIABLE creep_attacks_melee 0}
    {VARIABLE creep_attacks_ranged 0}
    {FOREACH creep.attack i}
      {VARIABLE_OP creep_attacks_$creep.attack[$i|].range| add 1}
    {NEXT i}
    {VARIABLE new_trait_i $creep.modifications.trait.length}
    {VARIABLE new_trait "creep.modifications.trait[$new_trait_i].id"}
    {VARIABLE $new_trait loyal}
    {VARIABLE new_trait "creep.modifications.trait[$new_trait_i].name"}
    {VARIABLE $new_trait (_ "loyal")}
    {VARIABLE new_trait "creep.modifications.trait[$new_trait_i].female_name"}
    {VARIABLE $new_trait (_ "female^loyal")}
    {VARIABLE new_trait "creep.modifications.trait[$new_trait_i].description"}
    {VARIABLE $new_trait  (_ "Zero upkeep")}
    {VARIABLE new_trait  "creep.modifications.trait[$new_trait_i].effect[0].apply_to"}
    {VARIABLE $new_trait loyal}
    {VARIABLE creep.role "recruits"}
    [unstore_unit]
      variable=creep
    [/unstore_unit]
    [if]
      {SXC_CMP brutal greater_than_equal_to 200}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 8 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=6
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=3500%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=900%
            increase_attacks=300%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=900%
            increase_attacks=300%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-40
              pierce=-40
              impact=-40
              fire=-40
              cold=-40
              arcane=-40
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 180}
      {SXC_CMP brutal less_than 200}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 8 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=6
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=3000%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=800%
            increase_attacks=260%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=800%
            increase_attacks=260%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-40
              pierce=-40
              impact=-40
              fire=-40
              cold=-40
              arcane=-40
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 160}
      {SXC_CMP brutal less_than 180}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 8 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=5
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=2600%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=700%
            increase_attacks=220%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=700%
            increase_attacks=220%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-40
              pierce=-40
              impact=-40
              fire=-40
              cold=-40
              arcane=-40
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 140}
      {SXC_CMP brutal less_than 160}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 8 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=5
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=2200%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=600%
            increase_attacks=180%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=600%
            increase_attacks=180%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-30
              pierce=-30
              impact=-30
              fire=-30
              cold=-30
              arcane=-30
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 120}
      {SXC_CMP brutal less_than 140}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 8 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=4
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=1800%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=500%
            increase_attacks=150%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=500%
            increase_attacks=150%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-30
              pierce=-30
              impact=-30
              fire=-30
              cold=-30
              arcane=-30
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 100}
      {SXC_CMP brutal less_than 120}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 8 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=4
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=1450%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=400%
            increase_attacks=120%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=400%
            increase_attacks=120%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-30
              pierce=-30
              impact=-30
              fire=-30
              cold=-30
              arcane=-30
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 90}
      {SXC_CMP brutal less_than 100}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 7 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=3
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=1200%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=350%
            increase_attacks=100%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=350%
            increase_attacks=100%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-20
              pierce=-20
              impact=-20
              fire=-20
              cold=-20
              arcane=-20
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 80}
      {SXC_CMP brutal less_than 90}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 7 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=3
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=950%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=300%
            increase_attacks=80%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=300%
            increase_attacks=80%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-20
              pierce=-20
              impact=-20
              fire=-20
              cold=-20
              arcane=-20
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 70}
      {SXC_CMP brutal less_than 80}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=3
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=700%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=250%
            increase_attacks=70%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=250%
            increase_attacks=70%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-20
              pierce=-20
              impact=-20
              fire=-20
              cold=-20
              arcane=-20
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 60}
      {SXC_CMP brutal less_than 70}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=2
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=500%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=200%
            increase_attacks=60%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=200%
            increase_attacks=60%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-20
              pierce=-20
              impact=-20
              fire=-20
              cold=-20
              arcane=-20
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 50}
      {SXC_CMP brutal less_than 60}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 6 2}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=2
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=300%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=150%
            increase_attacks=50%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=150%
            increase_attacks=50%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-20
              pierce=-20
              impact=-20
              fire=-20
              cold=-20
              arcane=-20
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 40}
      {SXC_CMP brutal less_than 50}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 5 2}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=2
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=200%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=100%
            increase_attacks=40%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=100%
            increase_attacks=40%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-10
              pierce=-10
              impact=-10
              fire=-10
              cold=-10
              arcane=-10
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 30}
      {SXC_CMP brutal less_than 40}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 4 2}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=1
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=100%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=75%
            increase_attacks=30%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=75%
            increase_attacks=30%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-10
              pierce=-10
              impact=-10
              fire=-10
              cold=-10
              arcane=-10
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 20}
      {SXC_CMP brutal less_than 30}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 4 2}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=1
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=50%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=50%
            increase_attacks=25%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=50%
            increase_attacks=25%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-10
              pierce=-10
              impact=-10
              fire=-10
              cold=-10
              arcane=-10
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 10}
      {SXC_CMP brutal less_than 20}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 4 1}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=hitpoints
            increase_total=25%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=25%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=25%
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SXC_CMP brutal greater_than_equal_to 0}
      {SXC_CMP brutal less_than 10}
      [then]
        [filter]
          x,y=$x1,$y1
          [filter_side]
            team_name=Enemies
          [/filter_side]
        [/filter]
        {SXC_ENEMY_UPGRADE_WEAPON 4 1}
      [/then]
    [/if]
    {CLEAR_VARIABLE new_trait_i}
    {CLEAR_VARIABLE new_trait}
    {CLEAR_VARIABLE creep}
    {CLEAR_VARIABLE creep_attacks_melee}
    {CLEAR_VARIABLE creep_attacks_ranged}
    {CLEAR_VARIABLE i}
    {VARIABLE_OP recruits_$side_number add 1}
    [if]
      {SXC_CMP side_number less_than 6}
      [then]
        # Show a console warning for bug #33 instead of trigging a WML error
        #
        # A proper fix will be (now that we have Wesnoth 1.14's support for more sides) to convert
        # all fake sides to real sides. That will have a small effect on map balance, as the fake
        # sides recruited at the start of each turn, even for turn 1.
        #
        # It doesn't affect the recruit limits of the real sides - recruits for fake sides are
        # labelled by setting "unit.role=fake_recruits", which means killing them doesn't change the
        # recruit count of the real side; and this role was set even if a WML error occured here, as
        # it's done in a separate event.
        [wml_message]
          message="SXC bug #33: fake side's recruits would be accounted to side $side_number|"
          logger=warn
        [/wml_message]
      [/then]
      [else]
        [if]
          {SXC_CMP recruits_$side_number greater_than 30}
          [then]
            [store_unit]
              [filter]
                side=$side_number
                role="big_boss"
              [/filter]
              variable=leader
            [/store_unit]
            {VARIABLE leader.canrecruit "no"}
            [unstore_unit]
              variable=leader
            [/unstore_unit]
            {CLEAR_VARIABLE leader}
          [/then]
        [/if]
      [/else]
    [/if]
  [/event]
#enddef

#define SXC_MEGA_CHALLENGE
  [event]
    name=turn 225
    [sound]
      name=dragonstick.ogg
    [/sound]
    [gold]
      side=6
      amount=9000
    [/gold]
    [gold]
      side=7
      amount=9000
    [/gold]
    [gold]
      side=8
      amount=9000
    [/gold]
    [gold]
      side=9
      amount=9000
    [/gold]
  [/event]
#enddef

# At the start of each turn, the players get bonus gold for each ai side whose leader is dead
#define SXC_INCOME_BONUS B6 B7 B8 B9
  {SXC_INCOME_BONUS_6 B6 B7 B8 B9 0 0}
#enddef

# A version of SXC_INCOME_BONUS for maps with up to 6 ai sides
#define SXC_INCOME_BONUS_6 B6 B7 B8 B9 B10 B11
  [event]
    name=new turn
    first_time_only=no
    {VARIABLE income_bonus 0}
    [if]
      [not]
        [have_unit]
          side=6
          role="big_boss"
        [/have_unit]
      [/not]
      [then]
        {VARIABLE_OP income_bonus add "{B6}"}
      [/then]
    [/if]
    [if]
      [not]
        [have_unit]
          side=7
          role="big_boss"
        [/have_unit]
      [/not]
      [then]
        {VARIABLE_OP income_bonus add "{B7}"}
      [/then]
    [/if]
    [if]
      [not]
        [have_unit]
          side=8
          role="big_boss"
        [/have_unit]
      [/not]
      [then]
        {VARIABLE_OP income_bonus add "{B8}"}
      [/then]
    [/if]
    [if]
      [not]
        [have_unit]
          side=9
          role="big_boss"
        [/have_unit]
      [/not]
      [then]
        {VARIABLE_OP income_bonus add "{B9}"}
      [/then]
    [/if]
    [if]
      [not]
        [have_unit]
          side=10
          role="big_boss"
        [/have_unit]
      [/not]
      [then]
        {VARIABLE_OP income_bonus add "{B10}"}
      [/then]
    [/if]
    [if]
      [not]
        [have_unit]
          side=11
          role="big_boss"
        [/have_unit]
      [/not]
      [then]
        {VARIABLE_OP income_bonus add "{B11}"}
      [/then]
    [/if]
    [if]
      {SXC_CMP difficulty greater_than_equal_to 175}
      [then]
        {VARIABLE_OP income_bonus multiply 0.4}
      [/then]
      [else]
        [if]
          {SXC_CMP difficulty greater_than_equal_to 150}
          [then]
            {VARIABLE_OP income_bonus multiply 0.6}
          [/then]
          [else]
            [if]
              {SXC_CMP difficulty greater_than_equal_to 125}
              [then]
                {VARIABLE_OP income_bonus multiply 0.8}
              [/then]
              [else]
                [if]
                  {SXC_CMP difficulty greater_than_equal_to 100}
                  [then]
                    {VARIABLE_OP income_bonus multiply 1.0}
                  [/then]
                  [else]
                    [if]
                      {SXC_CMP difficulty greater_than_equal_to 75}
                      [then]
                        {VARIABLE_OP income_bonus multiply 1.2}
                      [/then]
                      [else]
                        [if]
                          {SXC_CMP difficulty greater_than_equal_to 50}
                          [then]
                            {VARIABLE_OP income_bonus multiply 1.4}
                          [/then]
                        [/if]
                      [/else]
                    [/if]
                  [/else]
                [/if]
              [/else]
            [/if]
          [/else]
        [/if]
      [/else]
    [/if]
    {VARIABLE i 1}
    [while]
      {SXC_CMP i less_than_equal_to 5}
      [do]
        [if]
          [have_unit]
            side=$i
            canrecruit=yes
          [/have_unit]
          {SXC_CMP income_bonus greater_than_equal_to 1}
          [then]
            [gold]
              side=$i
              amount=$income_bonus
            [/gold]
            [store_unit]
              [filter]
                side=$i
                canrecruit=yes
              [/filter]
              variable=income_leader
            [/store_unit]
            [unstore_unit]
              variable=income_leader
              text=$income_bonus
              red,green,blue=255,255,0
            [/unstore_unit]
            {VARIABLE_OP income_$i| add $income_bonus}
          [/then]
        [/if]
        {VARIABLE_OP i add 1}
      [/do]
    [/while]
    {CLEAR_VARIABLE i}
    {CLEAR_VARIABLE income_bonus}
    {CLEAR_VARIABLE income_leader}
  [/event]
#enddef

#define SXC_ABILITY_EVENTS
  {ABILITY_SXC_MEGACURES_EVENT}
  {ABILITY_SXC_MINORCURES_EVENT}
  {ABILITY_SXC_MEGAREGENERATES_EVENT}
  {ABILITY_SXC_SOULSTEALER_EVENT}
#enddef

#define SXC_SET_TERRAIN X Y LETTER
  [terrain]
    x="{X}"
    y="{Y}"
    terrain={LETTER}
  [/terrain]
#enddef

# When ambushing a player by using MODIFY_TERRAIN or SXC_SET_TERRAIN on a wall
# next to them, let them see what the enemies are. Without this, it will remain
# shrouded until the character moves again
#
# Usage: use this once after one or more SXC_SET_TERRAIN or MODIFY_TERRAIN calls
#define SXC_REDRAW_TERRAIN
  [redraw]
    clear_shroud=true
    [filter_side]
      team_name=Heroes
    [/filter_side]
  [/redraw]
#enddef

#define SXC_INVENTORY
  [set_menu_item]
    id=SXC_Inventory
    description="View/manipulate items in inventory"
    image=icons/backpack.png
    [show_if]
      [have_unit]
        side=$side_number
        x,y=$x1,$y1
        canrecruit=yes
      [/have_unit]
    [/show_if]
    [command]
      [message]
        speaker=unit
        message="Inventory:"
        [option]
          message="Ok"
          [command]
          [/command]
        [/option]
        {SXC_DRINK_BLUE_POTION}
        {SXC_DRINK_CYAN_POTION}
        {SXC_DRINK_RED_POTION}
        {SXC_DRINK_YELLOW_POTION}
        {SXC_DROP_DEFRING}
        {SXC_DROP_RESRING}
        {SXC_DROP_BLUE_POTION}
        {SXC_DROP_CYAN_POTION}
        {SXC_DROP_RED_POTION}
        {SXC_DROP_YELLOW_POTION}
        {SXC_DROP_TARGET}
        {SXC_DROP_CLOAK}
        {SXC_DROP_CORNUCOPIA}
        {SXC_DROP_SCEPTRE}
        {SXC_DROP_SWORD}
        {SXC_DROP_BOW}
        {SXC_DROP_NECKLACE}
        {SXC_DROP_ICEARMOR}
        {SXC_DROP_FIREARMOR}
        {SXC_DROP_SPIRITSTAFF}
        {SXC_DROP_BUCKLER}
        {SXC_DROP_BARREL}
        {SXC_DROP_DWARFPLATE}
        {SXC_DROP_RINGDARKNESS}
        [redraw]
        [/redraw]
      [/message]
    [/command]
  [/set_menu_item]
#enddef
